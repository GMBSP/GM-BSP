<!-- ========== PASTE PART 1 ABOVE THIS LINE ========== -->
    
    <!-- Maps Page -->
    <div class="maps-page" id="mapsPage">
        <div class="maps-title">DOORS</div>
        <div class="maps-terminal" id="mapsTerminal"></div>
    </div>
    
    <!-- Data Page -->
    <div class="data-page" id="dataPage">
        <div class="data-title">DATA</div>
        <div class="data-terminal" id="dataTerminal"></div>
    </div>
    
    <!-- TGMT Page -->
    <div class="tgmt-page" id="tgmtPage">
        <div class="tgmt-header">
            <div class="tgmt-logo">I</div>
            <h1 class="tgmt-title">The GM Tower</h1>
        </div>
        <div class="tgmt-nav">
            <a href="#">Home</a>
        </div>
        <div class="tgmt-container">
            <div class="tgmt-sidebar">
                <div class="tgmt-sidebar-section">
                    <div class="tgmt-sidebar-title">ERROR</div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                </div>
                <div class="tgmt-sidebar-section">
                    <div class="tgmt-sidebar-title">ERROR</div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                </div>
            </div>
            <div class="tgmt-content">
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">SERVER</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                        <div class="tgmt-image">
                            <img src="1.png" alt="Image 1" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">MAP</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-image">
                            <img src="2.png" alt="Image 2" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">PLAYERS</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                        <div class="tgmt-image">
                            <img src="3.png" alt="Image 3" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">EVENTS</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-image">
                            <img src="4.png" alt="Image 4" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Page -->
    <div class="chat-page" id="chatPage">
        <div class="chat-header">
            <div class="chat-title">PUBLIC CHAT</div>
        </div>
        <div class="chat-messages-container" id="chatMessagesContainer"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." maxlength="500" />
            <button class="chat-send-btn" onclick="sendChatMessage()">SEND</button>
            
            <button class="chat-delete-all-btn" id="chatDeleteAllBtn" onclick="deleteAllChatMessages()">DELETE ALL</button>
            
        </div>
    </div>
    
    <button class="logout-btn" id="logoutBtn" onclick="logoutAdmin()">LOGOUT</button>
    <button class="admin-vote-btn" id="adminVoteBtn" onclick="openAdminVotePanel()">VOTE CONTROL</button>
    <button class="admin-sound-btn" id="adminSoundBtn" onclick="openAdminSoundPanel()">SOUND CONTROL</button>
    <button class="texture-control-btn" id="textureControlBtn" onclick="toggleMissingTexture()">TOGGLE TEXTURE</button>
    <button class="admin-loading-btn" id="adminLoadingBtn" onclick="openAdminLoadingPanel()">LOADING BAR</button>
    <button class="admin-video-btn" id="adminVideoBtn" onclick="toggleVideoControlHud()">VIDEO CONTROL</button>
    
    <div class="missing-texture-overlay" id="missingTextureOverlay"></div>
    
    <div class="loading-bar-overlay" id="loadingBarOverlay">
        <div class="loading-bar-container">
            <div class="loading-bar-text">LOADING</div>
            <div class="loading-bar" id="loadingBar">[..........] </div>
            <div>
                <span class="loading-percentage" id="loadingPercentage">0%</span>
                <span class="loading-time-remaining" id="loadingTimeRemaining">Time remaining: 0d 0h 0m 0s</span>
            </div>
        </div>
    </div>
    
    <div class="video-control-hud" id="videoControlHud">
        <h3>VIDEO CONTROL</h3>
        <button onclick="switchVideo('water.mp4')" data-video="water.mp4">WATER</button>
        <button onclick="switchVideo('water2.mp4')" data-video="water2.mp4">WATER2</button>
        <button onclick="switchVideo('water03.mp4')" data-video="water03.mp4">WATER03</button>
        <button onclick="switchVideo('city.mp4')" data-video="city.mp4">CITY</button>
        <button onclick="switchVideo('sighting.mp4')" data-video="sighting.mp4">SIGHTING</button>
        <button onclick="switchVideo('tree.mp4')" data-video="tree.mp4">TREE</button>
        <button onclick="toggleVideoControlHud()" style="margin-top: 10px; background: rgba(255, 68, 68, 0.8); border-color: #ff4444;">CLOSE</button>
    </div>
    
    <div class="vote-panel" id="votePanel">
        <h2>VOTE</h2>
        <div class="vote-question" id="voteQuestion">Loading...</div>
        <div class="vote-buttons">
            <button onclick="submitVote('yes')" id="yesBtn">YES</button>
            <button onclick="submitVote('no')" id="noBtn">NO</button>
        </div>
        <div class="vote-results" id="voteResults" style="display: none;"></div>
        <div class="vote-status" id="voteStatus"></div>
    </div>
    
    <div class="admin-vote-panel" id="adminVotePanel">
        <h2>VOTE CONTROL PANEL</h2>
        <textarea id="voteQuestionInput" placeholder="Enter vote question..."></textarea>
        <button onclick="startVote()">START VOTE</button>
        <button class="danger" onclick="endVote()">END VOTE</button>
        <button onclick="closeAdminVotePanel()">CLOSE</button>
        <div class="vote-results" id="adminVoteResults" style="margin-top: 20px;"></div>
    </div>
    
        <div class="admin-sound-panel" id="adminSoundPanel">
        <h2>SOUND CONTROL PANEL</h2>
        
        <!-- Current Playing Indicator -->
        <div class="current-playing" id="currentPlaying">
            <div class="current-playing-title">Currently Playing:</div>
            <div class="current-playing-info">
                <span id="currentSoundName">None</span>
                <span id="currentSoundVolume">100%</span>
            </div>
            <div class="current-playing-loops" id="currentSoundLoops">Loop: 1 / 1</div>
        </div>
        
        <!-- Sound Selection -->
        <label for="soundSelect">Select Sound:</label>
        <select id="soundSelect">
            <option value="">-- Select Sound --</option>
            <option value="windchime2.wav">Windchime 2</option>
            <option value="impact_water.mp3">Impact Water</option>
            <option value="friend-online-wav (2).mp3">Friend Online</option>
            <option value="windchime4-wav.mp3">Windchime 4</option>
            <option value="tv_music.wav">TV Music</option>
            <option value="friend_join.wav">Friend Join</option>
            <option value="warning.wav">Warning</option>
            <option value="button9.wav">Button 9</option>
            <option value="postroll.wav">Postroll</option>
            <option value="blip.wav">Blip</option>
            <option value="content_downloaded.wav">Content Downloaded</option>
        </select>
        
        <!-- Sound Controls Grid -->
        <div class="sound-controls-grid">
            <!-- Volume Control -->
            <div class="sound-control-item">
                <div class="volume-display">
                    <label for="soundVolume">Volume:</label>
                    <span class="volume-value" id="volumeValue">100%</span>
                </div>
                <input type="range" id="soundVolume" min="0" max="100" value="100" oninput="updateVolumeDisplay()" />
            </div>
            
            <!-- Loop Count -->
            <div class="sound-control-item">
                <label for="loopCount">Loop Count:</label>
                <input type="number" id="loopCount" min="1" max="999" value="1" />
            </div>
        </div>
        
        <!-- Loop Forever Checkbox -->
        <div class="loop-forever-container">
            <input type="checkbox" id="loopForever" onchange="toggleLoopForever()" />
            <label for="loopForever">Loop Forever (∞)</label>
        </div>
        
        <!-- Action Buttons -->
        <div class="sound-action-buttons">
            <button onclick="playSound()">▶ PLAY</button>
            <button class="stop-btn" onclick="stopSound()">■ STOP</button>
        </div>
        
        <button class="close-btn" onclick="closeAdminSoundPanel()">CLOSE</button>
    </div>
    <div class="admin-loading-panel" id="adminLoadingPanel">
        <h2>LOADING BAR CONTROL</h2>
        <div class="time-inputs">
            <div class="time-input-group">
                <label for="loadingDays">Days:</label>
                <input type="number" id="loadingDays" min="0" max="365" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingHours">Hours:</label>
                <input type="number" id="loadingHours" min="0" max="23" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingMinutes">Minutes:</label>
                <input type="number" id="loadingMinutes" min="0" max="59" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingSeconds">Seconds:</label>
                <input type="number" id="loadingSeconds" min="0" max="59" value="10" oninput="updateTotalTime()" />
            </div>
        </div>
        <div class="total-display" id="totalTimeDisplay">Total: 10 seconds</div>
        <button onclick="startLoadingBar()">START LOADING BAR</button>
        <button onclick="stopLoadingBar()">STOP LOADING BAR</button>
        <button onclick="closeAdminLoadingPanel()">CLOSE</button>
    </div>
    
    <audio id="globalSoundPlayer"></audio>
    <audio id="voteChimeSound">
        <source src="windchime2.wav" type="audio/wav">
    </audio>
    
    <div class="console" id="console">
        <div class="console-header">
            <span>SOURCE ENGINE CONSOLE</span>
            <span class="console-close" onclick="toggleConsole()">✕</span>
        </div>
        <div class="console-messages" id="consoleMessages"></div>
        <div class="console-input" id="consoleInput">
            <input type="text" id="messageInput" placeholder="Enter message..." />
            <button onclick="sendMessage()">SEND</button>
            <button class="danger" onclick="deleteAllMessages()">DELETE ALL</button>
        </div>
    </div>
    
    <button class="console-toggle" id="consoleToggle" onclick="toggleConsole()">CONSOLE (~)</button>
    
    <div class="redirect-overlay" id="redirectOverlay"></div>
    <div class="redirect-text" id="redirectText">REDIRECTING</div>
    <div class="counter" onclick="window.open('https://discord.gg/2MaeHsZ5GC', '_blank')">
        <div class="counter-label">ACTIVE USERS</div>
        <div class="counter-number" id="userCount">0</div>
    </div>
    <button class="audio-btn" id="audioBtn">CLICK TO START</button>
    <video autoplay muted playsinline id="mainVideo">
        <source src="water.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <audio loop id="bgAudio">
        <source src="water01.ogg" type="audio/ogg">
        <source src="water01.mp3" type="audio/mpeg">
        Your browser does not support the audio tag.
    </audio>
    <audio id="alertAudio">
        <source src="alert1.ogg" type="audio/ogg">
    </audio>
    <audio id="accessDeniedAudio">
        <source src="access_denied.mp3" type="audio/mpeg">
    </audio>
    
    
    

        <script type="module">
        // ========== CONSOLE WARNING ==========
        console.clear();
        console.log('%cI HAVE NO PRIVACY', 'color: #ff0000; font-size: 72px; font-weight: bold; text-shadow: 0 0 10px #ff0000;');
        
        // Periodic warning every 30 seconds
        setInterval(() => {
            console.clear();
            console.log('%cI HAVE NO PRIVACY', 'color: #ff0000; font-size: 72px; font-weight: bold; text-shadow: 0 0 10px #ff0000;');
        }, 30000);
    </script>

<script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, onDisconnect, serverTimestamp, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        

        const firebaseConfig = {
            apiKey: "AIzaSyCPj_IFALPhx8JL3tvdO-UzcsGorlx5czw",
            authDomain: "f-5faaa.firebaseapp.com",
            databaseURL: "https://f-5faaa-default-rtdb.firebaseio.com",
            projectId: "f-5faaa",
            storageBucket: "f-5faaa.firebasestorage.app",
            messagingSenderId: "403091114082",
            appId: "1:403091114082:web:3db7ac9f65060ad4d8e93b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        
        window.isAdmin = false;

        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const sessionRef = ref(database, 'sessions/' + sessionId);
        const counterElement = document.getElementById('userCount');

        set(sessionRef, {
            timestamp: serverTimestamp(),
            active: true
        });
        
        onDisconnect(sessionRef).remove();

        const sessionsRef = ref(database, 'sessions');
        onValue(sessionsRef, (snapshot) => {
            const sessions = snapshot.val();
            const activeCount = sessions ? Object.keys(sessions).length : 0;
            counterElement.textContent = activeCount;
        });

        setInterval(() => {
            set(sessionRef, {
                timestamp: serverTimestamp(),
                active: true
            });
        }, 10000);
        
        const soundTriggerRef = ref(database, 'soundTrigger');
        let lastSoundTimestamp = 0;
        
        onValue(soundTriggerRef, (snapshot) => {
            const trigger = snapshot.val();
            if (trigger && trigger.timestamp > lastSoundTimestamp) {
                lastSoundTimestamp = trigger.timestamp;
                const player = document.getElementById('globalSoundPlayer');
                player.src = trigger.soundFile;
                player.play().catch(e => console.log('Sound play failed:', e));
            }
        });
        
        const voteRef = ref(database, 'vote');
        let lastVoteCount = 0;
        
        onValue(voteRef, (snapshot) => {
            const vote = snapshot.val();
            const votePanel = document.getElementById('votePanel');
            
            if (vote && vote.active) {
                const votes = vote.votes || {};
                const currentVoteCount = Object.keys(votes).length;
                
                if (lastVoteCount > 0 && currentVoteCount > lastVoteCount) {
                    const chimeSound = document.getElementById('voteChimeSound');
                    chimeSound.currentTime = 0;
                    chimeSound.play().catch(e => console.log('Chime sound failed:', e));
                }
                lastVoteCount = currentVoteCount;
                
                document.getElementById('voteQuestion').textContent = vote.question;
                
                const userVoted = vote.votes && vote.votes[window.userId];
                
                if (userVoted) {
                    document.getElementById('yesBtn').disabled = true;
                    document.getElementById('noBtn').disabled = true;
                    document.getElementById('voteStatus').textContent = 'You voted: ' + userVoted.toUpperCase();
                    showVoteResults(vote);
                } else {
                    document.getElementById('yesBtn').disabled = false;
                    document.getElementById('noBtn').disabled = false;
                    document.getElementById('voteStatus').textContent = '';
                    document.getElementById('voteResults').style.display = 'none';
                }
                
                votePanel.classList.add('active');
                
                if (window.isAdmin) {
                    updateAdminVoteResults(vote);
                }
            } else {
                votePanel.classList.remove('active');
                lastVoteCount = 0;
            }
        });
        
        function showVoteResults(vote) {
            const resultsDiv = document.getElementById('voteResults');
            const votes = vote.votes || {};
            
            let yesCount = 0;
            let noCount = 0;
            
            Object.values(votes).forEach(v => {
                if (v === 'yes') yesCount++;
                if (v === 'no') noCount++;
            });
            
            const total = yesCount + noCount;
            const yesPercent = total > 0 ? (yesCount / total * 100).toFixed(1) : 0;
            const noPercent = total > 0 ? (noCount / total * 100).toFixed(1) : 0;
            
            resultsDiv.innerHTML = `
                <div class="vote-result-item">
                    <span>YES: ${yesCount} votes (${yesPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${yesPercent}%"></div>
                    <div class="vote-result-label">YES</div>
                </div>
                <div class="vote-result-item">
                    <span>NO: ${noCount} votes (${noPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${noPercent}%"></div>
                    <div class="vote-result-label">NO</div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #888;">
                    Total votes: ${total}
                </div>
            `;
            resultsDiv.style.display = 'block';
        }
        
        function updateAdminVoteResults(vote) {
            const adminResultsDiv = document.getElementById('adminVoteResults');
            if (!adminResultsDiv) return;
            
            const votes = vote.votes || {};
            let yesCount = 0;
            let noCount = 0;
            
            Object.values(votes).forEach(v => {
                if (v === 'yes') yesCount++;
                if (v === 'no') noCount++;
            });
            
            const total = yesCount + noCount;
            const yesPercent = total > 0 ? (yesCount / total * 100).toFixed(1) : 0;
            const noPercent = total > 0 ? (noCount / total * 100).toFixed(1) : 0;
            
            adminResultsDiv.innerHTML = `
                <h3 style="margin-bottom: 15px; font-size: 16px;">LIVE RESULTS</h3>
                <div class="vote-result-item">
                    <span>YES: ${yesCount} votes (${yesPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${yesPercent}%"></div>
                    <div class="vote-result-label">YES</div>
                </div>
                <div class="vote-result-item">
                    <span>NO: ${noCount} votes (${noPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${noPercent}%"></div>
                    <div class="vote-result-label">NO</div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #888;">
                    Total votes: ${total}
                </div>
            `;
        }
        
        window.loginAdmin = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginSuccess').style.display = 'block';
                document.getElementById('loginError').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('loginSuccess').style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Login error:', error);
                
                const chimeSound = document.getElementById('voteChimeSound');
                const accessDeniedAudio = document.getElementById('accessDeniedAudio');
                
                chimeSound.currentTime = 0;
                chimeSound.play().catch(e => console.log('Chime sound failed:', e));
                
                setTimeout(() => {
                    accessDeniedAudio.currentTime = 0;
                    accessDeniedAudio.play().catch(e => console.log('Access denied sound failed:', e));
                }, 500);
                
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginSuccess').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        };
        
        window.logoutAdmin = async function() {
            try {
                await signOut(auth);
                console.log('Admin logged out');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
        
        window.deleteMessage = async function(msgId) {
            if (!window.isAdmin) return;
            
            const msgRef = ref(database, 'messages/' + msgId);
            await update(msgRef, {
                deleted: true,
                text: '',
                username: ''
            });
        };
        
        window.sendMessage = async function() {
            if (!window.isAdmin) return;
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text) {
                const upperText = text.toUpperCase();
                if (upperText === 'RUN VRAD.EXE' || upperText === 'FIND SOURCEENGINE.MDL') {
                    const textureRef = ref(database, 'missingTexture');
                    
                    try {
                        await set(textureRef, {
                            active: true,
                            timestamp: Date.now()
                        });
                        console.log('Missing texture activated via command');
                    } catch (error) {
                        console.error('Failed to activate texture:', error);
                    }
                }
                
                const messagesRef = ref(database, 'messages');
                await push(messagesRef, {
                    username: 'SOURCEENGINE',
                    text: text,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        };
        
        window.deleteAllMessages = async function() {
            if (!window.isAdmin) return;
            
            if (confirm('Are you sure you want to delete ALL messages? This cannot be undone!')) {
                const messagesRef = ref(database, 'messages');
                await set(messagesRef, null);
                console.log('All messages deleted');
            }
        };
        
        window.submitVote = async function(choice) {
            if (!window.userId) return;
            
            const snapshot = await new Promise(resolve => {
                onValue(voteRef, resolve, { onlyOnce: true });
            });
            
            const vote = snapshot.val();
            if (!vote || !vote.active) return;
            
            if (vote.votes && vote.votes[window.userId]) {
                alert('You have already voted!');
                return;
            }
            
            try {
                const userVoteRef = ref(database, `vote/votes/${window.userId}`);
                await set(userVoteRef, choice);
                console.log('Vote submitted:', choice);
            } catch (error) {
                console.error('Vote error:', error);
                alert('Error submitting vote. Please try again.');
            }
        };
        
        window.openAdminVotePanel = function() {
            document.getElementById('adminVotePanel').classList.add('active');
        };
        
        window.closeAdminVotePanel = function() {
            document.getElementById('adminVotePanel').classList.remove('active');
        };
        
        window.startVote = async function() {
            if (!window.isAdmin) return;
            
            const question = document.getElementById('voteQuestionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            await set(voteRef, {
                question: question,
                active: true,
                votes: {},
                startedAt: Date.now()
            });
            
            document.getElementById('voteQuestionInput').value = '';
            alert('Vote started!');
        };
        
        window.endVote = async function() {
            if (!window.isAdmin) return;
            
            if (!confirm('Are you sure you want to end the current vote?')) return;
            
            await update(voteRef, {
                active: false
            });
            
            alert('Vote ended!');
        };
        
        window.openAdminSoundPanel = function() {
            document.getElementById('adminSoundPanel').classList.add('active');
        };
        
        window.closeAdminSoundPanel = function() {
            document.getElementById('adminSoundPanel').classList.remove('active');
        };
        
        
        
        window.toggleMissingTexture = async function() {
            if (!window.isAdmin) return;
            
            const textureRef = ref(database, 'missingTexture');
            const snapshot = await new Promise(resolve => {
                onValue(textureRef, resolve, { onlyOnce: true });
            });
            
            const currentState = snapshot.val();
            const newState = !(currentState && currentState.active);
            
            await set(textureRef, {
                active: newState,
                timestamp: Date.now()
            });
            
            console.log('Missing texture overlay:', newState ? 'ON' : 'OFF');
        };
        
        window.openAdminLoadingPanel = function() {
            document.getElementById('adminLoadingPanel').classList.add('active');
        };
        
        window.closeAdminLoadingPanel = function() {
            document.getElementById('adminLoadingPanel').classList.remove('active');
        };
        
        window.toggleVideoControlHud = function() {
            const hud = document.getElementById('videoControlHud');
            hud.classList.toggle('active');
        };
        
        window.confirmUsername = function() {
            const input = document.getElementById('usernameInput');
            const username = input.value.trim().toUpperCase();
            const errorDiv = document.getElementById('usernameError');
            
            if (!username) {
                errorDiv.textContent = 'ERROR: USERNAME REQUIRED';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (username === 'SOURCEENGINE') {
                errorDiv.textContent = 'ERROR: INVALID USERNAME';
                errorDiv.style.display = 'block';
                
                const chimeSound = document.getElementById('voteChimeSound');
                chimeSound.currentTime = 0;
                chimeSound.play().catch(e => console.log('Error sound failed:', e));
                
                return;
            }
            
            window.chatUsername = username;
            localStorage.setItem('chatUsername', username);
            document.getElementById('usernameModal').classList.remove('active');
            console.log('Username set:', username);
        };
        
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const messagesRef = ref(database, 'chatMessages');
            const displayUsername = (window.isAdmin ? "SOURCEENGINE" : (window.chatUsername || "Anonymous"));
            
            // Security: Block users from using admin username
            if (!window.isAdmin && displayUsername.toUpperCase() === "SOURCEENGINE") {
                alert("Cannot use reserved username!");
                return;
            }
            
            try {
                await push(messagesRef, {
                    username: window.isAdmin ? "SOURCEENGINE" : (displayUsername === "SOURCEENGINE" ? "User" : displayUsername),
                    text: text,
                    timestamp: Date.now(),
                    isAdmin: window.isAdmin || false,
                    userId: window.userId
                });
                
                input.value = '';
                console.log('Chat message sent');
            } catch (error) {
                console.error('Error sending chat message:', error);
            }
        };
        
        window.deleteChatMessage = async function(msgId) {
            if (!window.isAdmin) return;
            
            const msgRef = ref(database, 'chatMessages/' + msgId);
            try {
                await remove(msgRef);
                console.log('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        };
        
        window.deleteAllChatMessages = async function() {
            if (!window.isAdmin) return;
            
            if (!confirm('Are you sure you want to delete ALL chat messages? This cannot be undone!')) return;
            
            const messagesRef = ref(database, 'chatMessages');
            try {
                await set(messagesRef, null);
                console.log('All chat messages deleted');
            } catch (error) {
                console.error('Error deleting all messages:', error);
            }
        };
        
        
        
        // NEW: Delete all messages from a user
        window.deleteAllUserMessages = async function(username) {
            if (!window.isAdmin) return;
            
            if (!confirm(`Delete ALL messages from ${username}? This cannot be undone!`)) return;
            
            try {
                const messagesRef = ref(database, 'chatMessages');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    const deletePromises = [];
                    
                    // Find and delete all messages from this user
                    Object.entries(messages).forEach(([msgId, msg]) => {
                        if (msg.username === username) {
                            const msgRef = ref(database, `chatMessages/${msgId}`);
                            deletePromises.push(remove(msgRef));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    console.log(`Deleted all messages from ${username}`);
                }
            } catch (error) {
                console.error('Error deleting user messages:', error);
                alert('Failed to delete messages: ' + error.message);
            }
        };
        
        
        // HTML escape function to prevent injection
        window.escapeHtml = function(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };
        
        window.setupChatPage = function() {
            const chatMessagesRef = ref(database, 'chatMessages');
            
            onValue(chatMessagesRef, (snapshot) => {
                const messages = snapshot.val();
                const container = document.getElementById('chatMessagesContainer');
                container.innerHTML = '';
                
                if (messages) {
                    const messageArray = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);
                    
                    messageArray.forEach(([msgId, msg]) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';
                        
                        const time = new Date(msg.timestamp).toLocaleTimeString();
                        const usernameClass = msg.isAdmin ? 'admin' : '';
                        
                        // Admin controls with "DELETE USER" button
                        // Delete buttons now created safely with DOM methods
                        
                        let messageContent = '';
                        if (msg.imageUrl) {
                            messageContent = `<img src="${msg.imageUrl}" class="chat-image" alt="Shared image" onclick="window.open('${msg.imageUrl}', '_blank')" />`;
                        } else if (msg.text) {
                            messageContent = `<div class="chat-text">${escapeHtml(msg.text)}</div>`;
                        }
                        
                        // Safe DOM creation instead of innerHTML
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'chat-message-content';
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'chat-message-header';
                        
                        const usernameSpan = document.createElement('span');
                        usernameSpan.className = 'chat-username ' + usernameClass;
                        usernameSpan.textContent = msg.username; // textContent is safe
                        
                        const timestampSpan = document.createElement('span');
                        timestampSpan.className = 'chat-timestamp';
                        timestampSpan.textContent = time; // textContent is safe
                        
                        headerDiv.appendChild(usernameSpan);
                        headerDiv.appendChild(timestampSpan);
                        contentDiv.appendChild(headerDiv);
                        
                        // Add message text safely
                        if (msg.text) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'chat-text';
                            textDiv.textContent = msg.text; // textContent prevents XSS
                            contentDiv.appendChild(textDiv);
                        }
                        
                        msgDiv.appendChild(contentDiv);
                        
                        // Add admin controls if admin
                        if (window.isAdmin) {
                            const controlsDiv = document.createElement('div');
                            
                            const deleteBtn = document.createElement('span');
                            deleteBtn.className = 'chat-delete-btn';
                            deleteBtn.textContent = 'DELETE';
                            deleteBtn.onclick = () => deleteChatMessage(msgId);
                            
                            const deleteUserBtn = document.createElement('span');
                            deleteUserBtn.className = 'chat-delete-user-btn';
                            deleteUserBtn.textContent = 'DELETE USER';
                            deleteUserBtn.onclick = () => deleteAllUserMessages(msg.username);
                            
                            controlsDiv.appendChild(deleteBtn);
                            controlsDiv.appendChild(deleteUserBtn);
                            msgDiv.appendChild(controlsDiv);
                        }
                        
                        container.appendChild(msgDiv);
                    });
                    
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No messages yet. Be the first to chat!</div>';
                }
            });
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput && !chatInput.dataset.listenerAdded) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
                chatInput.dataset.listenerAdded = 'true';
            }
            
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput && !usernameInput.dataset.listenerAdded) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmUsername();
                    }
                });
                usernameInput.dataset.listenerAdded = 'true';
            }
            
            console.log('Chat page initialized');
        };
        
        window.updateTotalTime = function() {
            const days = parseInt(document.getElementById('loadingDays').value) || 0;
            const hours = parseInt(document.getElementById('loadingHours').value) || 0;
            const minutes = parseInt(document.getElementById('loadingMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('loadingSeconds').value) || 0;
            
            const totalSeconds = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;
            
            let displayText = 'Total: ';
            if (days > 0) displayText += days + ' day' + (days > 1 ? 's ' : ' ');
            if (hours > 0) displayText += hours + ' hour' + (hours > 1 ? 's ' : ' ');
            if (minutes > 0) displayText += minutes + ' minute' + (minutes > 1 ? 's ' : ' ');
            if (seconds > 0) displayText += seconds + ' second' + (seconds > 1 ? 's' : '');
            
            if (totalSeconds === 0) displayText = 'Total: 0 seconds';
            
            document.getElementById('totalTimeDisplay').textContent = displayText;
        };
        
        window.startLoadingBar = async function() {
            if (!window.isAdmin) return;
            
            const days = parseInt(document.getElementById('loadingDays').value) || 0;
            const hours = parseInt(document.getElementById('loadingHours').value) || 0;
            const minutes = parseInt(document.getElementById('loadingMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('loadingSeconds').value) || 0;
            
            const totalSeconds = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;
            
            if (totalSeconds < 1) {
                alert('Please enter a valid duration!');
                return;
            }
            
            const loadingRef = ref(database, 'loadingBar');
            await set(loadingRef, {
                active: true,
                duration: totalSeconds,
                startTime: Date.now()
            });
            
            console.log('Loading bar started:', totalSeconds, 'seconds');
        };
        
        window.stopLoadingBar = async function() {
            if (!window.isAdmin) return;
            
            const loadingRef = ref(database, 'loadingBar');
            await set(loadingRef, {
                active: false
            });
            
            console.log('Loading bar stopped');
        };
        
        const loadingBarRef = ref(database, 'loadingBar');
        let loadingInterval = null;
        
        onValue(loadingBarRef, (snapshot) => {
            const loadingState = snapshot.val();
            const overlay = document.getElementById('loadingBarOverlay');
            
            if (loadingState && loadingState.active) {
                overlay.classList.add('active');
                
                const duration = loadingState.duration * 1000;
                const startTime = loadingState.startTime;
                const totalBlocks = 10;
                
                if (loadingInterval) clearInterval(loadingInterval);
                
                loadingInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const percentage = Math.floor(progress * 100);
                    const filledBlocks = Math.floor(progress * totalBlocks);
                    
                    let barText = '[';
                    for (let i = 0; i < totalBlocks; i++) {
                        if (i < filledBlocks) {
                            barText += '<span class="filled">█</span>';
                        } else {
                            barText += '.';
                        }
                    }
                    barText += ']';
                    
                    document.getElementById('loadingBar').innerHTML = barText;
                    document.getElementById('loadingPercentage').textContent = percentage + '%';
                    
                    const remaining = Math.max(0, duration - elapsed);
                    const remainingSeconds = Math.floor(remaining / 1000);
                    const remDays = Math.floor(remainingSeconds / 86400);
                    const remHours = Math.floor((remainingSeconds % 86400) / 3600);
                    const remMinutes = Math.floor((remainingSeconds % 3600) / 60);
                    const remSecs = remainingSeconds % 60;
                    
                    document.getElementById('loadingTimeRemaining').textContent = 
                        `Time remaining: ${remDays}d ${remHours}h ${remMinutes}m ${remSecs}s`;
                    
                    if (progress >= 1) {
                        clearInterval(loadingInterval);
                        setTimeout(async () => {
                            overlay.classList.remove('active');
                            await set(loadingBarRef, { active: false });
                        }, 2000);
                    }
                }, 50);
            } else {
                overlay.classList.remove('active');
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.isAdmin = true;
                window.adminEmail = user.email;
                window.userId = user.uid;
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('consoleInput').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('adminVoteBtn').style.display = 'block';
                document.getElementById('adminSoundBtn').style.display = 'block';
                document.getElementById('textureControlBtn').style.display = 'block';
                document.getElementById('adminLoadingBtn').style.display = 'block';
                document.getElementById('adminVideoBtn').style.display = 'block';
                if (document.getElementById('adminChatToggleBtn')) document.getElementById('adminChatToggleBtn').style.display = 'block';
                
                document.getElementById('chatDeleteAllBtn').style.display = 'block';
                console.log('Admin logged in:', user.email);
                
                setTimeout(() => {
                    const event = new Event('admin-login');
                    window.dispatchEvent(event);
                }, 100);
            } else {
                window.isAdmin = false;
                window.adminEmail = null;
                window.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                document.getElementById('consoleInput').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminVoteBtn').style.display = 'none';
                document.getElementById('adminSoundBtn').style.display = 'none';
                document.getElementById('videoControlHud').classList.remove('active');
                document.getElementById('textureControlBtn').style.display = 'none';
                document.getElementById('adminLoadingBtn').style.display = 'none';
                document.getElementById('adminVideoBtn').style.display = 'none';
                document.getElementById('adminChatToggleBtn').style.display = 'none';
                
                document.getElementById('chatDeleteAllBtn').style.display = 'none';
            }
        });
        
        const messagesRef = ref(database, 'messages');
        let isFirstLoad = true;
        let messageCount = 0;
        
        function renderMessages() {
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                const messagesDiv = document.getElementById('consoleMessages');
                messagesDiv.innerHTML = '';
                
                if (messages) {
                    const messageArray = Object.entries(messages);
                    messageArray.forEach(([msgId, msg]) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'console-message' + (msg.deleted ? ' deleted' : '');
                        const time = new Date(msg.timestamp).toLocaleTimeString();
                        
                        if (msg.deleted) {
                            msgDiv.innerHTML = `<div class="message-content"><span class="timestamp">[${time}]</span><span style="color: #ff4444;">ERROR</span></div>`;
                        } else {
                            // Delete buttons now created safely with DOM methods
                            msgDiv.innerHTML = `
                                <div class="message-content">
                                    <span class="timestamp">[${time}]</span><span class="username">${msg.username}:</span>${msg.text}
                                </div>
                                ${deleteBtn}
                            `;
                        }
                        messagesDiv.appendChild(msgDiv);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    const currentCount = messageArray.length;
                    if (!isFirstLoad && currentCount > messageCount) {
                        const alertSound = document.getElementById('alertAudio');
                        if (alertSound) {
                            alertSound.currentTime = 0;
                            alertSound.play().catch(e => console.log('Alert sound failed:', e));
                        }
                    }
                    messageCount = currentCount;
                    isFirstLoad = false;
                }
            });
        }
        
        renderMessages();
        window.addEventListener('admin-login', renderMessages);
        
        const videoStateRef = ref(database, 'videoState');
        onValue(videoStateRef, (snapshot) => {
            const videoState = snapshot.val();
            
            if (videoState && videoState.currentVideo) {
                const newVideo = videoState.currentVideo;
                
                if (newVideo !== window.currentVideo) {
                    const mainVideo = document.getElementById('mainVideo');
                    mainVideo.src = newVideo;
                    mainVideo.load();
                    mainVideo.loop = (newVideo === 'water2.mp4' || newVideo === 'water03.mp4' || newVideo === 'city.mp4' || newVideo === 'sighting.mp4' || newVideo === 'tree.mp4' || newVideo === 'water.mp4');
                    mainVideo.muted = true;
                    mainVideo.play()
                        .then(() => console.log('Video switched successfully'))
                        .catch(e => console.error('Video switch failed:', e));
                    
                    window.currentVideo = newVideo;
                    
                    if (window.isAdmin) {
                        document.querySelectorAll('.video-control-hud button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        const activeBtn = document.querySelector(`[data-video="${newVideo}"]`);
                        if (activeBtn) activeBtn.classList.add('active');
                    }
                }
            }
        });
        
        
        // ========== ENHANCED SOUND CONTROL SYSTEM ==========
        
        window.soundControlState = {
            currentSound: null,
            currentLoop: 0,
            totalLoops: 1,
            isPlaying: false,
            volume: 1.0,
            loopForever: false
        };
        
        window.updateVolumeDisplay = function() {
            const volumeSlider = document.getElementById('soundVolume');
            const volumeValue = document.getElementById('volumeValue');
            if (volumeSlider && volumeValue) {
                volumeValue.textContent = volumeSlider.value + '%';
            }
        };
        
        window.toggleLoopForever = function() {
            const loopForever = document.getElementById('loopForever');
            const loopCount = document.getElementById('loopCount');
            
            if (loopForever && loopCount) {
                if (loopForever.checked) {
                    loopCount.disabled = true;
                    loopCount.style.opacity = '0.5';
                } else {
                    loopCount.disabled = false;
                    loopCount.style.opacity = '1';
                }
            }
        };
        
        window.playSound = async function() {
            if (!window.isAdmin) return;
            
            const soundSelect = document.getElementById('soundSelect');
            const soundFile = soundSelect.value;
            const volumeSlider = document.getElementById('soundVolume');
            const loopCountInput = document.getElementById('loopCount');
            const loopForeverCheckbox = document.getElementById('loopForever');
            
            if (!soundFile) {
                alert('Please select a sound!');
                return;
            }
            
            const volume = parseInt(volumeSlider.value) / 100;
            const loopCount = loopForeverCheckbox.checked ? -1 : parseInt(loopCountInput.value) || 1;
            
            const soundControlRef = ref(database, 'soundControl');
            
            try {
                await set(soundControlRef, {
                    soundFile: soundFile,
                    volume: volume,
                    loopCount: loopCount,
                    timestamp: Date.now(),
                    isPlaying: true
                });
                
                console.log('Sound control updated:', {
                    file: soundFile,
                    volume: volume,
                    loops: loopCount === -1 ? 'infinite' : loopCount
                });
                
                updateCurrentPlayingDisplay(soundFile, volume, loopCount);
                
            } catch (error) {
                console.error('Failed to play sound:', error);
                alert('Error playing sound: ' + error.message);
            }
        };
        
        window.stopSound = async function() {
            if (!window.isAdmin) return;
            
            const soundControlRef = ref(database, 'soundControl');
            
            try {
                await set(soundControlRef, {
                    isPlaying: false,
                    timestamp: Date.now()
                });
                
                const player = document.getElementById('globalSoundPlayer');
                player.pause();
                player.currentTime = 0;
                
                document.getElementById('currentPlaying').classList.remove('active');
                
                window.soundControlState.isPlaying = false;
                window.soundControlState.currentLoop = 0;
                
                console.log('Sound stopped');
                
            } catch (error) {
                console.error('Failed to stop sound:', error);
            }
        };
        
        window.updateCurrentPlayingDisplay = function(soundFile, volume, loopCount) {
            const currentPlaying = document.getElementById('currentPlaying');
            const soundName = document.getElementById('currentSoundName');
            const soundVolume = document.getElementById('currentSoundVolume');
            const soundLoops = document.getElementById('currentSoundLoops');
            
            const fileName = soundFile.split('/').pop().replace(/\.[^/.]+$/, "");
            
            soundName.textContent = fileName;
            soundVolume.textContent = Math.round(volume * 100) + '%';
            
            if (loopCount === -1) {
                soundLoops.textContent = 'Loop: ∞ (Forever)';
            } else {
                soundLoops.textContent = `Loop: 1 / ${loopCount}`;
            }
            
            currentPlaying.classList.add('active');
        };
        
        window.playSoundWithLoop = function() {
            const player = document.getElementById('globalSoundPlayer');
            const state = window.soundControlState;
            
            player.src = state.currentSound;
            player.volume = state.volume;
            
            player.onended = null;
            
            player.onended = function() {
                state.currentLoop++;
                
                if (window.isAdmin && state.totalLoops !== -1) {
                    const soundLoops = document.getElementById('currentSoundLoops');
                    if (soundLoops) {
                        soundLoops.textContent = `Loop: ${state.currentLoop + 1} / ${state.totalLoops}`;
                    }
                }
                
                if (state.loopForever || state.currentLoop < state.totalLoops) {
                    player.currentTime = 0;
                    player.play().catch(e => console.log('Loop play failed:', e));
                } else {
                    state.isPlaying = false;
                    if (window.isAdmin) {
                        document.getElementById('currentPlaying').classList.remove('active');
                    }
                }
            };
            
            player.play().catch(e => console.log('Sound play failed:', e));
            
            console.log('Playing sound:', {
                file: state.currentSound,
                volume: Math.round(state.volume * 100) + '%',
                loops: state.loopForever ? '∞' : state.totalLoops
            });
        };
        
        const soundControlRef = ref(database, 'soundControl');
        
        onValue(soundControlRef, (snapshot) => {
            const control = snapshot.val();
            
            if (!control || !control.isPlaying) {
                const player = document.getElementById('globalSoundPlayer');
                player.pause();
                player.currentTime = 0;
                window.soundControlState.isPlaying = false;
                return;
            }
            
            const { soundFile, volume, loopCount, timestamp } = control;
            
            if (timestamp > (window.soundControlState.lastTimestamp || 0)) {
                window.soundControlState.lastTimestamp = timestamp;
                window.soundControlState.currentSound = soundFile;
                window.soundControlState.volume = volume;
                window.soundControlState.totalLoops = loopCount;
                window.soundControlState.currentLoop = 0;
                window.soundControlState.loopForever = loopCount === -1;
                window.soundControlState.isPlaying = true;
                
                playSoundWithLoop();
            }
        });
        
        setTimeout(() => {
            if (typeof updateVolumeDisplay === 'function') {
                updateVolumeDisplay();
            }
        }, 1000);
        

        
        // ========== CHAT ENABLE/DISABLE SYSTEM ==========
        
        window.toggleChatEnabled = async function() {
            if (!window.isAdmin) return;
            
            const chatEnabledRef = ref(database, 'chatEnabled');
            const snapshot = await new Promise(resolve => {
                onValue(chatEnabledRef, resolve, { onlyOnce: true });
            });
            
            const currentState = snapshot.val();
            const newState = currentState === undefined ? false : !currentState;
            
            await set(chatEnabledRef, newState);
            
            console.log('Chat enabled:', newState);
        };
        
        const chatEnabledRef = ref(database, 'chatEnabled');
        
        onValue(chatEnabledRef, (snapshot) => {
            const enabled = snapshot.val();
            const overlay = document.getElementById('chatDisabledOverlay');
            const toggleBtn = document.getElementById('adminChatToggleBtn');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.querySelector('.chat-send-btn');
            
            // Default to enabled if not set
            const isEnabled = enabled === null || enabled === undefined || enabled === true;
            
            if (window.location.search.includes('chat')) {
                if (!isEnabled) {
                    overlay.classList.add('active');
                    if (chatInput) chatInput.disabled = true;
                    if (sendBtn) sendBtn.disabled = true;
                } else {
                    overlay.classList.remove('active');
                    if (chatInput) chatInput.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                }
            }
            
            if (window.isAdmin && toggleBtn) {
                if (isEnabled) {
                    toggleBtn.textContent = 'DISABLE CHAT';
                    toggleBtn.classList.remove('disabled');
                } else {
                    toggleBtn.textContent = 'ENABLE CHAT';
                    toggleBtn.classList.add('disabled');
                }
            }
        });
        

        const missingTextureRef = ref(database, 'missingTexture');
        onValue(missingTextureRef, (snapshot) => {
            const textureState = snapshot.val();
            const overlay = document.getElementById('missingTextureOverlay');
            
            if (textureState && textureState.active) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        });
    </script>

    <script>
        window.currentVideo = 'water.mp4';
        let audioStarted = false;
        
        if (window.location.search.includes('admin')) {
            document.getElementById('loginPage').classList.add('active');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        if (window.location.search.includes('maps')) {
            document.getElementById('mapsPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            startMapTerminal();
        }
        
        if (window.location.search.includes('data')) {
            document.getElementById('dataPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            startDataTerminal();
        }
        
        if (window.location.search.includes('tgmt')) {
            document.getElementById('tgmtPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
        }
        
        if (window.location.search.includes('chat')) {
            document.getElementById('chatPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            
            const savedUsername = localStorage.getItem('chatUsername');
            if (!savedUsername && !window.isAdmin) {
                setTimeout(() => {
                    document.getElementById('usernameModal').classList.add('active');
                }, 500);
            } else if (savedUsername) {
                window.chatUsername = savedUsername;
            }
            
            setTimeout(() => {
                if (typeof setupChatPage === 'function') {
                    setupChatPage();
                }
            }, 100);
        }
        
        const sourceEngineMaps = [
            'maps/cp_dustbowl.bsp', 'maps/ctf_2fort.bsp', 'maps/pl_badwater.bsp',
            'maps/koth_harvest.bsp', 'maps/pl_upward.bsp', 'maps/cp_granary.bsp',
            'maps/ctf_turbine.bsp', 'maps/pl_goldrush.bsp', 'maps/cp_gravelpit.bsp',
            'maps/koth_nucleus.bsp', 'maps/d1_trainstation_01.bsp', 'maps/d1_canals_01.bsp',
            'maps/d1_town_01.bsp', 'maps/d2_coast_01.bsp', 'maps/d3_c17_01.bsp',
            'maps/ep1_citadel_00.bsp', 'maps/ep2_outland_01.bsp', 'maps/de_dust2.bsp',
            'maps/cs_office.bsp', 'maps/de_inferno.bsp', 'maps/de_nuke.bsp',
            'maps/cs_italy.bsp', 'maps/de_aztec.bsp', 'maps/de_train.bsp',
            'maps/cs_assault.bsp', 'maps/gm_construct.bsp', 'maps/gm_flatgrass.bsp',
            'maps/rp_downtown_v4c.bsp', 'maps/gm_bigcity.bsp', 'maps/rp_evocity_v4b1.bsp',
            'maps/ph_restaurant.bsp', 'maps/ttt_minecraft_b5.bsp', 'maps/gm_fork.bsp',
            'maps/de_dust.bsp', 'maps/cs_militia.bsp', 'maps/cp_badlands.bsp',
            'maps/pl_frontier_final.bsp', 'maps/ctf_sawmill.bsp', 'maps/koth_king.bsp',
            'maps/cp_steel.bsp', 'maps/pl_thundermountain.bsp', 'maps/koth_viaduct.bsp',
            'maps/cp_gorge.bsp', 'maps/ctf_doublecross.bsp', 'maps/pl_hoodoo_final.bsp',
            'maps/d1_canals_02.bsp', 'maps/d1_canals_03.bsp', 'maps/d1_eli_01.bsp',
            'maps/d2_prison_01.bsp', 'maps/d2_coast_03.bsp', 'maps/d3_breen_01.bsp',
            'maps/ep1_c17_00.bsp', 'maps/ep2_outland_05.bsp', 'maps/de_cbble.bsp',
            'maps/de_mirage.bsp', 'maps/cs_compound.bsp', 'maps/gm_mobenix_v1_5.bsp',
            'maps/rp_florida.bsp', 'maps/dm_lockdown.bsp', 'maps/de_prodigy.bsp',
            'maps/cs_havana.bsp', 'maps/pl_swiftwater_final1.bsp', 'maps/cp_foundry.bsp',
            'maps/koth_lakeside_final.bsp', 'maps/arena_lumberyard.bsp', 'maps/cp_egypt_final.bsp',
            'maps/pl_barnblitz.bsp', 'maps/ctf_well.bsp', 'maps/cp_yukon_final.bsp',
            'maps/pl_cashworks.bsp', 'maps/koth_badlands.bsp', 'maps/cp_process_final.bsp',
            'maps/d1_trainstation_02.bsp', 'maps/d1_town_02.bsp', 'maps/d2_coast_09.bsp',
            'maps/d3_c17_05.bsp', 'maps/ep1_citadel_03.bsp', 'maps/ep2_outland_12.bsp',
            'maps/gm_wireburg.bsp', 'maps/rp_rockford_v2b.bsp', 'maps/ttt_67thway_v14.bsp',
            'maps/gm_flatgrass_v3.bsp', 'maps/ph_manor.bsp', 'maps/de_cache.bsp',
            'maps/cs_agency.bsp', 'maps/cp_well.bsp', 'maps/arena_watchtower.bsp',
            'maps/koth_sawmill.bsp'
        ];
        
        function startMapTerminal() {
            const terminal = document.getElementById('mapsTerminal');
            let lineCount = 0;
            const maxLines = 100;
            
            function addLine() {
                if (lineCount >= maxLines) {
                    const firstLine = terminal.firstChild;
                    if (firstLine) terminal.removeChild(firstLine);
                }
                
                const line = document.createElement('div');
                line.className = 'maps-line';
                
                if (Math.random() < 0.15) {
                    line.classList.add('highlight');
                }
                
                const map = sourceEngineMaps[Math.floor(Math.random() * sourceEngineMaps.length)];
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const statuses = ['LOADING', 'PARSING', 'MOUNTING', 'INDEXING', 'VERIFIED', 'CACHED'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                line.textContent = `[${timestamp}] ${status}: ${map}`;
                
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
                
                lineCount++;
            }
            
            for (let i = 0; i < 30; i++) {
                setTimeout(addLine, i * 50);
            }
            
            function scheduleNextLine() {
                const delay = Math.random() * 300 + 100;
                setTimeout(() => {
                    addLine();
                    scheduleNextLine();
                }, delay);
            }
            
            scheduleNextLine();
        }
        
        function startDataTerminal() {
            const terminal = document.getElementById('dataTerminal');
            let lineCount = 0;
            const maxLines = 100;
            
            function addLine() {
                if (lineCount >= maxLines) {
                    const firstLine = terminal.firstChild;
                    if (firstLine) terminal.removeChild(firstLine);
                }
                
                const line = document.createElement('div');
                line.className = 'data-line';
                
                const map = sourceEngineMaps[Math.floor(Math.random() * sourceEngineMaps.length)];
                
                const rand = Math.random();
                let status, statusClass;
                if (rand < 0.7) {
                    status = 'PERFECT';
                    statusClass = 'perfect';
                } else if (rand < 0.9) {
                    status = 'DAMAGED';
                    statusClass = 'damaged';
                } else {
                    status = 'CORRUPTED';
                    statusClass = 'corrupted';
                }
                
                line.innerHTML = `
                    <span class="data-file">${map}</span>
                    <span class="data-status ${statusClass}">[${status}]</span>
                `;
                
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
                
                lineCount++;
            }
            
            for (let i = 0; i < 30; i++) {
                setTimeout(addLine, i * 50);
            }
            
            function scheduleNextLine() {
                const delay = Math.random() * 300 + 100;
                setTimeout(() => {
                    addLine();
                    scheduleNextLine();
                }, delay);
            }
            
            scheduleNextLine();
        }
        
        function makeDraggable(element) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            let xOffset = 0, yOffset = 0;

            element.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            element.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', dragEnd);

            function dragStart(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                isDragging = true;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    xOffset = currentX;
                    yOffset = currentY;

                    element.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            makeDraggable(document.getElementById('videoControlHud'));
            makeDraggable(document.getElementById('adminVotePanel'));
            makeDraggable(document.getElementById('adminSoundPanel'));
            makeDraggable(document.getElementById('adminLoadingPanel'));
            
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            const loginPassword = document.getElementById('loginPassword');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginAdmin();
                    }
                });
            }
        });
        
        function toggleConsole() {
            document.getElementById('console').classList.toggle('active');
        }
        
        window.switchVideo = async function(videoFile) {
            if (!window.isAdmin) return;
            
            const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const videoStateRef = ref(window.firebaseDB, 'videoState');
            
            try {
                await set(videoStateRef, {
                    currentVideo: videoFile,
                    timestamp: Date.now()
                });
                console.log('Video state updated in Firebase');
            } catch (error) {
                console.error('Failed to update video state:', error);
            }
        };
        
        document.addEventListener('keydown', (e) => {
            if (e.key === '`' || e.key === '~') {
                e.preventDefault();
                toggleConsole();
            }
        });
        
        const mainVideo = document.getElementById('mainVideo');
        const audioElement = document.getElementById('bgAudio');
        const audioBtn = document.getElementById('audioBtn');

        document.body.addEventListener('click', () => {
            if (!audioStarted) {
                audioElement.play();
                audioBtn.textContent = 'MUTE';
                audioStarted = true;
            }
        }, { once: true });

        audioBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (audioElement.paused) {
                audioElement.play();
                audioBtn.textContent = 'MUTE';
            } else {
                audioElement.pause();
                audioBtn.textContent = 'UNMUTE';
            }
            audioStarted = true;
        });

        audioElement.play().then(() => {
            audioBtn.textContent = 'MUTE';
            audioStarted = true;
        }).catch(() => {
            audioBtn.textContent = 'CLICK TO START';
        });
    </script>

    <!-- Chat Disabled Overlay -->
    <div class="chat-disabled-overlay" id="chatDisabledOverlay">
        <div class="chat-disabled-message">CHAT DISABLED</div>
    </div>
    
    <button class="admin-chat-toggle-btn" id="adminChatToggleBtn" onclick="toggleChatEnabled()">DISABLE CHAT</button>


    <!-- Elements Tab Warning -->
    <div class="elements-warning" aria-hidden="true">LEAVE ME ALONE</div>

</body>
</html>
    
    <!-- Maps Page -->
    <div class="maps-page" id="mapsPage">
        <div class="maps-title">DOORS</div>
        <div class="maps-terminal" id="mapsTerminal"></div>
    </div>
    
    <!-- Data Page -->
    <div class="data-page" id="dataPage">
        <div class="data-title">DATA</div>
        <div class="data-terminal" id="dataTerminal"></div>
    </div>
    
    <!-- TGMT Page -->
    <div class="tgmt-page" id="tgmtPage">
        <div class="tgmt-header">
            <div class="tgmt-logo">I</div>
            <h1 class="tgmt-title">The GM Tower</h1>
        </div>
        <div class="tgmt-nav">
            <a href="#">Home</a>
        </div>
        <div class="tgmt-container">
            <div class="tgmt-sidebar">
                <div class="tgmt-sidebar-section">
                    <div class="tgmt-sidebar-title">ERROR</div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                </div>
                <div class="tgmt-sidebar-section">
                    <div class="tgmt-sidebar-title">ERROR</div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                    <div class="tgmt-sidebar-item">
                        <span>ERROR</span>
                    </div>
                </div>
            </div>
            <div class="tgmt-content">
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">SERVER</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                        <div class="tgmt-image">
                            <img src="1.png" alt="Image 1" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">MAP</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-image">
                            <img src="2.png" alt="Image 2" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">PLAYERS</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                        <div class="tgmt-image">
                            <img src="3.png" alt="Image 3" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                    </div>
                </div>
                
                <div class="tgmt-section">
                    <h2 class="tgmt-section-title">EVENTS</h2>
                    <div class="tgmt-section-content">
                        <div class="tgmt-image">
                            <img src="4.png" alt="Image 4" onerror="this.parentElement.innerHTML='<div class=\'tgmt-image-placeholder\'>IMAGE HERE</div>'">
                        </div>
                        <div class="tgmt-text">
                            <div class="tgmt-error-text">ERROR</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Page -->
    <div class="chat-page" id="chatPage">
        <div class="chat-header">
            <div class="chat-title">PUBLIC CHAT</div>
        </div>
        <div class="chat-messages-container" id="chatMessagesContainer"></div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." maxlength="500" />
            <button class="chat-send-btn" onclick="sendChatMessage()">SEND</button>
            
            <button class="chat-delete-all-btn" id="chatDeleteAllBtn" onclick="deleteAllChatMessages()">DELETE ALL</button>
            
        </div>
    </div>
    
    <button class="logout-btn" id="logoutBtn" onclick="logoutAdmin()">LOGOUT</button>
    <button class="admin-vote-btn" id="adminVoteBtn" onclick="openAdminVotePanel()">VOTE CONTROL</button>
    <button class="admin-sound-btn" id="adminSoundBtn" onclick="openAdminSoundPanel()">SOUND CONTROL</button>
    <button class="texture-control-btn" id="textureControlBtn" onclick="toggleMissingTexture()">TOGGLE TEXTURE</button>
    <button class="admin-loading-btn" id="adminLoadingBtn" onclick="openAdminLoadingPanel()">LOADING BAR</button>
    <button class="admin-video-btn" id="adminVideoBtn" onclick="toggleVideoControlHud()">VIDEO CONTROL</button>
    
    <div class="missing-texture-overlay" id="missingTextureOverlay"></div>
    
    <div class="loading-bar-overlay" id="loadingBarOverlay">
        <div class="loading-bar-container">
            <div class="loading-bar-text">LOADING</div>
            <div class="loading-bar" id="loadingBar">[..........] </div>
            <div>
                <span class="loading-percentage" id="loadingPercentage">0%</span>
                <span class="loading-time-remaining" id="loadingTimeRemaining">Time remaining: 0d 0h 0m 0s</span>
            </div>
        </div>
    </div>
    
    <div class="video-control-hud" id="videoControlHud">
        <h3>VIDEO CONTROL</h3>
        <button onclick="switchVideo('water.mp4')" data-video="water.mp4">WATER</button>
        <button onclick="switchVideo('water2.mp4')" data-video="water2.mp4">WATER2</button>
        <button onclick="switchVideo('water03.mp4')" data-video="water03.mp4">WATER03</button>
        <button onclick="switchVideo('city.mp4')" data-video="city.mp4">CITY</button>
        <button onclick="switchVideo('sighting.mp4')" data-video="sighting.mp4">SIGHTING</button>
        <button onclick="switchVideo('tree.mp4')" data-video="tree.mp4">TREE</button>
        <button onclick="toggleVideoControlHud()" style="margin-top: 10px; background: rgba(255, 68, 68, 0.8); border-color: #ff4444;">CLOSE</button>
    </div>
    
    <div class="vote-panel" id="votePanel">
        <h2>VOTE</h2>
        <div class="vote-question" id="voteQuestion">Loading...</div>
        <div class="vote-buttons">
            <button onclick="submitVote('yes')" id="yesBtn">YES</button>
            <button onclick="submitVote('no')" id="noBtn">NO</button>
        </div>
        <div class="vote-results" id="voteResults" style="display: none;"></div>
        <div class="vote-status" id="voteStatus"></div>
    </div>
    
    <div class="admin-vote-panel" id="adminVotePanel">
        <h2>VOTE CONTROL PANEL</h2>
        <textarea id="voteQuestionInput" placeholder="Enter vote question..."></textarea>
        <button onclick="startVote()">START VOTE</button>
        <button class="danger" onclick="endVote()">END VOTE</button>
        <button onclick="closeAdminVotePanel()">CLOSE</button>
        <div class="vote-results" id="adminVoteResults" style="margin-top: 20px;"></div>
    </div>
    
        <div class="admin-sound-panel" id="adminSoundPanel">
        <h2>SOUND CONTROL PANEL</h2>
        
        <!-- Current Playing Indicator -->
        <div class="current-playing" id="currentPlaying">
            <div class="current-playing-title">Currently Playing:</div>
            <div class="current-playing-info">
                <span id="currentSoundName">None</span>
                <span id="currentSoundVolume">100%</span>
            </div>
            <div class="current-playing-loops" id="currentSoundLoops">Loop: 1 / 1</div>
        </div>
        
        <!-- Sound Selection -->
        <label for="soundSelect">Select Sound:</label>
        <select id="soundSelect">
            <option value="">-- Select Sound --</option>
            <option value="windchime2.wav">Windchime 2</option>
            <option value="impact_water.mp3">Impact Water</option>
            <option value="friend-online-wav (2).mp3">Friend Online</option>
            <option value="windchime4-wav.mp3">Windchime 4</option>
            <option value="tv_music.wav">TV Music</option>
            <option value="friend_join.wav">Friend Join</option>
            <option value="warning.wav">Warning</option>
            <option value="button9.wav">Button 9</option>
            <option value="postroll.wav">Postroll</option>
            <option value="blip.wav">Blip</option>
            <option value="content_downloaded.wav">Content Downloaded</option>
        </select>
        
        <!-- Sound Controls Grid -->
        <div class="sound-controls-grid">
            <!-- Volume Control -->
            <div class="sound-control-item">
                <div class="volume-display">
                    <label for="soundVolume">Volume:</label>
                    <span class="volume-value" id="volumeValue">100%</span>
                </div>
                <input type="range" id="soundVolume" min="0" max="100" value="100" oninput="updateVolumeDisplay()" />
            </div>
            
            <!-- Loop Count -->
            <div class="sound-control-item">
                <label for="loopCount">Loop Count:</label>
                <input type="number" id="loopCount" min="1" max="999" value="1" />
            </div>
        </div>
        
        <!-- Loop Forever Checkbox -->
        <div class="loop-forever-container">
            <input type="checkbox" id="loopForever" onchange="toggleLoopForever()" />
            <label for="loopForever">Loop Forever (∞)</label>
        </div>
        
        <!-- Action Buttons -->
        <div class="sound-action-buttons">
            <button onclick="playSound()">▶ PLAY</button>
            <button class="stop-btn" onclick="stopSound()">■ STOP</button>
        </div>
        
        <button class="close-btn" onclick="closeAdminSoundPanel()">CLOSE</button>
    </div>
    <div class="admin-loading-panel" id="adminLoadingPanel">
        <h2>LOADING BAR CONTROL</h2>
        <div class="time-inputs">
            <div class="time-input-group">
                <label for="loadingDays">Days:</label>
                <input type="number" id="loadingDays" min="0" max="365" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingHours">Hours:</label>
                <input type="number" id="loadingHours" min="0" max="23" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingMinutes">Minutes:</label>
                <input type="number" id="loadingMinutes" min="0" max="59" value="0" oninput="updateTotalTime()" />
            </div>
            <div class="time-input-group">
                <label for="loadingSeconds">Seconds:</label>
                <input type="number" id="loadingSeconds" min="0" max="59" value="10" oninput="updateTotalTime()" />
            </div>
        </div>
        <div class="total-display" id="totalTimeDisplay">Total: 10 seconds</div>
        <button onclick="startLoadingBar()">START LOADING BAR</button>
        <button onclick="stopLoadingBar()">STOP LOADING BAR</button>
        <button onclick="closeAdminLoadingPanel()">CLOSE</button>
    </div>
    
    <audio id="globalSoundPlayer"></audio>
    <audio id="voteChimeSound">
        <source src="windchime2.wav" type="audio/wav">
    </audio>
    
    <div class="console" id="console">
        <div class="console-header">
            <span>SOURCE ENGINE CONSOLE</span>
            <span class="console-close" onclick="toggleConsole()">✕</span>
        </div>
        <div class="console-messages" id="consoleMessages"></div>
        <div class="console-input" id="consoleInput">
            <input type="text" id="messageInput" placeholder="Enter message..." />
            <button onclick="sendMessage()">SEND</button>
            <button class="danger" onclick="deleteAllMessages()">DELETE ALL</button>
        </div>
    </div>
    
    <button class="console-toggle" id="consoleToggle" onclick="toggleConsole()">CONSOLE (~)</button>
    
    <div class="redirect-overlay" id="redirectOverlay"></div>
    <div class="redirect-text" id="redirectText">REDIRECTING</div>
    <div class="counter" onclick="window.open('https://discord.gg/2MaeHsZ5GC', '_blank')">
        <div class="counter-label">ACTIVE USERS</div>
        <div class="counter-number" id="userCount">0</div>
    </div>
    <button class="audio-btn" id="audioBtn">CLICK TO START</button>
    <video autoplay muted playsinline id="mainVideo">
        <source src="water.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <audio loop id="bgAudio">
        <source src="water01.ogg" type="audio/ogg">
        <source src="water01.mp3" type="audio/mpeg">
        Your browser does not support the audio tag.
    </audio>
    <audio id="alertAudio">
        <source src="alert1.ogg" type="audio/ogg">
    </audio>
    <audio id="accessDeniedAudio">
        <source src="access_denied.mp3" type="audio/mpeg">
    </audio>
    
    
    

        <script type="module">
        // ========== CONSOLE WARNING ==========
        console.clear();
        console.log('%cLEAVE ME ALONE', 'color: #ff0000; font-size: 72px; font-weight: bold; text-shadow: 0 0 10px #ff0000;');
        
        // Periodic warning every 30 seconds
        setInterval(() => {
            console.clear();
            console.log('%cLEAVE ME ALONE', 'color: #ff0000; font-size: 72px; font-weight: bold; text-shadow: 0 0 10px #ff0000;');
        }, 30000);
    </script>

<script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, onDisconnect, serverTimestamp, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        

        const firebaseConfig = {
            apiKey: "AIzaSyCPj_IFALPhx8JL3tvdO-UzcsGorlx5czw",
            authDomain: "f-5faaa.firebaseapp.com",
            databaseURL: "https://f-5faaa-default-rtdb.firebaseio.com",
            projectId: "f-5faaa",
            storageBucket: "f-5faaa.firebasestorage.app",
            messagingSenderId: "403091114082",
            appId: "1:403091114082:web:3db7ac9f65060ad4d8e93b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        
        window.isAdmin = false;

        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const sessionRef = ref(database, 'sessions/' + sessionId);
        const counterElement = document.getElementById('userCount');

        set(sessionRef, {
            timestamp: serverTimestamp(),
            active: true
        });
        
        onDisconnect(sessionRef).remove();

        const sessionsRef = ref(database, 'sessions');
        onValue(sessionsRef, (snapshot) => {
            const sessions = snapshot.val();
            const activeCount = sessions ? Object.keys(sessions).length : 0;
            counterElement.textContent = activeCount;
        });

        setInterval(() => {
            set(sessionRef, {
                timestamp: serverTimestamp(),
                active: true
            });
        }, 10000);
        
        const soundTriggerRef = ref(database, 'soundTrigger');
        let lastSoundTimestamp = 0;
        
        onValue(soundTriggerRef, (snapshot) => {
            const trigger = snapshot.val();
            if (trigger && trigger.timestamp > lastSoundTimestamp) {
                lastSoundTimestamp = trigger.timestamp;
                const player = document.getElementById('globalSoundPlayer');
                player.src = trigger.soundFile;
                player.play().catch(e => console.log('Sound play failed:', e));
            }
        });
        
        const voteRef = ref(database, 'vote');
        let lastVoteCount = 0;
        
        onValue(voteRef, (snapshot) => {
            const vote = snapshot.val();
            const votePanel = document.getElementById('votePanel');
            
            if (vote && vote.active) {
                const votes = vote.votes || {};
                const currentVoteCount = Object.keys(votes).length;
                
                if (lastVoteCount > 0 && currentVoteCount > lastVoteCount) {
                    const chimeSound = document.getElementById('voteChimeSound');
                    chimeSound.currentTime = 0;
                    chimeSound.play().catch(e => console.log('Chime sound failed:', e));
                }
                lastVoteCount = currentVoteCount;
                
                document.getElementById('voteQuestion').textContent = vote.question;
                
                const userVoted = vote.votes && vote.votes[window.userId];
                
                if (userVoted) {
                    document.getElementById('yesBtn').disabled = true;
                    document.getElementById('noBtn').disabled = true;
                    document.getElementById('voteStatus').textContent = 'You voted: ' + userVoted.toUpperCase();
                    showVoteResults(vote);
                } else {
                    document.getElementById('yesBtn').disabled = false;
                    document.getElementById('noBtn').disabled = false;
                    document.getElementById('voteStatus').textContent = '';
                    document.getElementById('voteResults').style.display = 'none';
                }
                
                votePanel.classList.add('active');
                
                if (window.isAdmin) {
                    updateAdminVoteResults(vote);
                }
            } else {
                votePanel.classList.remove('active');
                lastVoteCount = 0;
            }
        });
        
        function showVoteResults(vote) {
            const resultsDiv = document.getElementById('voteResults');
            const votes = vote.votes || {};
            
            let yesCount = 0;
            let noCount = 0;
            
            Object.values(votes).forEach(v => {
                if (v === 'yes') yesCount++;
                if (v === 'no') noCount++;
            });
            
            const total = yesCount + noCount;
            const yesPercent = total > 0 ? (yesCount / total * 100).toFixed(1) : 0;
            const noPercent = total > 0 ? (noCount / total * 100).toFixed(1) : 0;
            
            resultsDiv.innerHTML = `
                <div class="vote-result-item">
                    <span>YES: ${yesCount} votes (${yesPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${yesPercent}%"></div>
                    <div class="vote-result-label">YES</div>
                </div>
                <div class="vote-result-item">
                    <span>NO: ${noCount} votes (${noPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${noPercent}%"></div>
                    <div class="vote-result-label">NO</div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #888;">
                    Total votes: ${total}
                </div>
            `;
            resultsDiv.style.display = 'block';
        }
        
        function updateAdminVoteResults(vote) {
            const adminResultsDiv = document.getElementById('adminVoteResults');
            if (!adminResultsDiv) return;
            
            const votes = vote.votes || {};
            let yesCount = 0;
            let noCount = 0;
            
            Object.values(votes).forEach(v => {
                if (v === 'yes') yesCount++;
                if (v === 'no') noCount++;
            });
            
            const total = yesCount + noCount;
            const yesPercent = total > 0 ? (yesCount / total * 100).toFixed(1) : 0;
            const noPercent = total > 0 ? (noCount / total * 100).toFixed(1) : 0;
            
            adminResultsDiv.innerHTML = `
                <h3 style="margin-bottom: 15px; font-size: 16px;">LIVE RESULTS</h3>
                <div class="vote-result-item">
                    <span>YES: ${yesCount} votes (${yesPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${yesPercent}%"></div>
                    <div class="vote-result-label">YES</div>
                </div>
                <div class="vote-result-item">
                    <span>NO: ${noCount} votes (${noPercent}%)</span>
                </div>
                <div class="vote-result-bar">
                    <div class="vote-result-bar-fill" style="width: ${noPercent}%"></div>
                    <div class="vote-result-label">NO</div>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #888;">
                    Total votes: ${total}
                </div>
            `;
        }
        
        window.loginAdmin = async function() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('loginSuccess').style.display = 'block';
                document.getElementById('loginError').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('loginSuccess').style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('Login error:', error);
                
                const chimeSound = document.getElementById('voteChimeSound');
                const accessDeniedAudio = document.getElementById('accessDeniedAudio');
                
                chimeSound.currentTime = 0;
                chimeSound.play().catch(e => console.log('Chime sound failed:', e));
                
                setTimeout(() => {
                    accessDeniedAudio.currentTime = 0;
                    accessDeniedAudio.play().catch(e => console.log('Access denied sound failed:', e));
                }, 500);
                
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginSuccess').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        };
        
        window.logoutAdmin = async function() {
            try {
                await signOut(auth);
                console.log('Admin logged out');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
        
        window.deleteMessage = async function(msgId) {
            if (!window.isAdmin) return;
            
            const msgRef = ref(database, 'messages/' + msgId);
            await update(msgRef, {
                deleted: true,
                text: '',
                username: ''
            });
        };
        
        window.sendMessage = async function() {
            if (!window.isAdmin) return;
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text) {
                const upperText = text.toUpperCase();
                if (upperText === 'RUN VRAD.EXE' || upperText === 'FIND SOURCEENGINE.MDL') {
                    const textureRef = ref(database, 'missingTexture');
                    
                    try {
                        await set(textureRef, {
                            active: true,
                            timestamp: Date.now()
                        });
                        console.log('Missing texture activated via command');
                    } catch (error) {
                        console.error('Failed to activate texture:', error);
                    }
                }
                
                const messagesRef = ref(database, 'messages');
                await push(messagesRef, {
                    username: 'SOURCEENGINE',
                    text: text,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        };
        
        window.deleteAllMessages = async function() {
            if (!window.isAdmin) return;
            
            if (confirm('Are you sure you want to delete ALL messages? This cannot be undone!')) {
                const messagesRef = ref(database, 'messages');
                await set(messagesRef, null);
                console.log('All messages deleted');
            }
        };
        
        window.submitVote = async function(choice) {
            if (!window.userId) return;
            
            const snapshot = await new Promise(resolve => {
                onValue(voteRef, resolve, { onlyOnce: true });
            });
            
            const vote = snapshot.val();
            if (!vote || !vote.active) return;
            
            if (vote.votes && vote.votes[window.userId]) {
                alert('You have already voted!');
                return;
            }
            
            try {
                const userVoteRef = ref(database, `vote/votes/${window.userId}`);
                await set(userVoteRef, choice);
                console.log('Vote submitted:', choice);
            } catch (error) {
                console.error('Vote error:', error);
                alert('Error submitting vote. Please try again.');
            }
        };
        
        window.openAdminVotePanel = function() {
            document.getElementById('adminVotePanel').classList.add('active');
        };
        
        window.closeAdminVotePanel = function() {
            document.getElementById('adminVotePanel').classList.remove('active');
        };
        
        window.startVote = async function() {
            if (!window.isAdmin) return;
            
            const question = document.getElementById('voteQuestionInput').value.trim();
            if (!question) {
                alert('Please enter a question!');
                return;
            }
            
            await set(voteRef, {
                question: question,
                active: true,
                votes: {},
                startedAt: Date.now()
            });
            
            document.getElementById('voteQuestionInput').value = '';
            alert('Vote started!');
        };
        
        window.endVote = async function() {
            if (!window.isAdmin) return;
            
            if (!confirm('Are you sure you want to end the current vote?')) return;
            
            await update(voteRef, {
                active: false
            });
            
            alert('Vote ended!');
        };
        
        window.openAdminSoundPanel = function() {
            document.getElementById('adminSoundPanel').classList.add('active');
        };
        
        window.closeAdminSoundPanel = function() {
            document.getElementById('adminSoundPanel').classList.remove('active');
        };
        
        
        
        window.toggleMissingTexture = async function() {
            if (!window.isAdmin) return;
            
            const textureRef = ref(database, 'missingTexture');
            const snapshot = await new Promise(resolve => {
                onValue(textureRef, resolve, { onlyOnce: true });
            });
            
            const currentState = snapshot.val();
            const newState = !(currentState && currentState.active);
            
            await set(textureRef, {
                active: newState,
                timestamp: Date.now()
            });
            
            console.log('Missing texture overlay:', newState ? 'ON' : 'OFF');
        };
        
        window.openAdminLoadingPanel = function() {
            document.getElementById('adminLoadingPanel').classList.add('active');
        };
        
        window.closeAdminLoadingPanel = function() {
            document.getElementById('adminLoadingPanel').classList.remove('active');
        };
        
        window.toggleVideoControlHud = function() {
            const hud = document.getElementById('videoControlHud');
            hud.classList.toggle('active');
        };
        
        window.confirmUsername = function() {
            const input = document.getElementById('usernameInput');
            const username = input.value.trim().toUpperCase();
            const errorDiv = document.getElementById('usernameError');
            
            if (!username) {
                errorDiv.textContent = 'ERROR: USERNAME REQUIRED';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (username === 'SOURCEENGINE') {
                errorDiv.textContent = 'ERROR: INVALID USERNAME';
                errorDiv.style.display = 'block';
                
                const chimeSound = document.getElementById('voteChimeSound');
                chimeSound.currentTime = 0;
                chimeSound.play().catch(e => console.log('Error sound failed:', e));
                
                return;
            }
            
            window.chatUsername = username;
            localStorage.setItem('chatUsername', username);
            document.getElementById('usernameModal').classList.remove('active');
            console.log('Username set:', username);
        };
        
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const messagesRef = ref(database, 'chatMessages');
            const displayUsername = (window.isAdmin ? "SOURCEENGINE" : (window.chatUsername || "Anonymous"));
            
            // Security: Block users from using admin username
            if (!window.isAdmin && displayUsername.toUpperCase() === "SOURCEENGINE") {
                alert("Cannot use reserved username!");
                return;
            }
            
            try {
                await push(messagesRef, {
                    username: window.isAdmin ? "SOURCEENGINE" : (displayUsername === "SOURCEENGINE" ? "User" : displayUsername),
                    text: text,
                    timestamp: Date.now(),
                    isAdmin: window.isAdmin || false,
                    userId: window.userId
                });
                
                input.value = '';
                console.log('Chat message sent');
            } catch (error) {
                console.error('Error sending chat message:', error);
            }
        };
        
        window.deleteChatMessage = async function(msgId) {
            if (!window.isAdmin) return;
            
            const msgRef = ref(database, 'chatMessages/' + msgId);
            try {
                await remove(msgRef);
                console.log('Message deleted');
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        };
        
        window.deleteAllChatMessages = async function() {
            if (!window.isAdmin) return;
            
            if (!confirm('Are you sure you want to delete ALL chat messages? This cannot be undone!')) return;
            
            const messagesRef = ref(database, 'chatMessages');
            try {
                await set(messagesRef, null);
                console.log('All chat messages deleted');
            } catch (error) {
                console.error('Error deleting all messages:', error);
            }
        };
        
        
        
        // NEW: Delete all messages from a user
        window.deleteAllUserMessages = async function(username) {
            if (!window.isAdmin) return;
            
            if (!confirm(`Delete ALL messages from ${username}? This cannot be undone!`)) return;
            
            try {
                const messagesRef = ref(database, 'chatMessages');
                const snapshot = await get(messagesRef);
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    const deletePromises = [];
                    
                    // Find and delete all messages from this user
                    Object.entries(messages).forEach(([msgId, msg]) => {
                        if (msg.username === username) {
                            const msgRef = ref(database, `chatMessages/${msgId}`);
                            deletePromises.push(remove(msgRef));
                        }
                    });
                    
                    await Promise.all(deletePromises);
                    console.log(`Deleted all messages from ${username}`);
                }
            } catch (error) {
                console.error('Error deleting user messages:', error);
                alert('Failed to delete messages: ' + error.message);
            }
        };
        
        
        // HTML escape function to prevent injection
        window.escapeHtml = function(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };
        
        window.setupChatPage = function() {
            const chatMessagesRef = ref(database, 'chatMessages');
            
            onValue(chatMessagesRef, (snapshot) => {
                const messages = snapshot.val();
                const container = document.getElementById('chatMessagesContainer');
                container.innerHTML = '';
                
                if (messages) {
                    const messageArray = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);
                    
                    messageArray.forEach(([msgId, msg]) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';
                        
                        const time = new Date(msg.timestamp).toLocaleTimeString();
                        const usernameClass = msg.isAdmin ? 'admin' : '';
                        
                        // Delete buttons created safely with DOM methods
                        
                        let messageContent = '';
                        if (msg.imageUrl) {
                            messageContent = `<img src="${msg.imageUrl}" class="chat-image" alt="Shared image" onclick="window.open('${msg.imageUrl}', '_blank')" />`;
                        } else if (msg.text) {
                            messageContent = `<div class="chat-text">${escapeHtml(msg.text)}</div>`;
                        }
                        
                        // Safe DOM creation instead of innerHTML
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'chat-message-content';
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'chat-message-header';
                        
                        const usernameSpan = document.createElement('span');
                        usernameSpan.className = 'chat-username ' + usernameClass;
                        usernameSpan.textContent = msg.username; // textContent is safe
                        
                        const timestampSpan = document.createElement('span');
                        timestampSpan.className = 'chat-timestamp';
                        timestampSpan.textContent = time; // textContent is safe
                        
                        headerDiv.appendChild(usernameSpan);
                        headerDiv.appendChild(timestampSpan);
                        contentDiv.appendChild(headerDiv);
                        
                        // Add message text safely
                        if (msg.text) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'chat-text';
                            textDiv.textContent = msg.text; // textContent prevents XSS
                            contentDiv.appendChild(textDiv);
                        }
                        
                        msgDiv.appendChild(contentDiv);
                        
                        // Add admin controls if admin
                        if (window.isAdmin) {
                            const controlsDiv = document.createElement('div');
                            
                            const deleteBtn = document.createElement('span');
                            deleteBtn.className = 'chat-delete-btn';
                            deleteBtn.textContent = 'DELETE';
                            deleteBtn.onclick = () => deleteChatMessage(msgId);
                            
                            const deleteUserBtn = document.createElement('span');
                            deleteUserBtn.className = 'chat-delete-user-btn';
                            deleteUserBtn.textContent = 'DELETE USER';
                            deleteUserBtn.onclick = () => deleteAllUserMessages(msg.username);
                            
                            controlsDiv.appendChild(deleteBtn);
                            controlsDiv.appendChild(deleteUserBtn);
                            msgDiv.appendChild(controlsDiv);
                        }
                        
                        container.appendChild(msgDiv);
                    });
                    
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No messages yet. Be the first to chat!</div>';
                }
            });
            
            const chatInput = document.getElementById('chatInput');
            if (chatInput && !chatInput.dataset.listenerAdded) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
                chatInput.dataset.listenerAdded = 'true';
            }
            
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput && !usernameInput.dataset.listenerAdded) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmUsername();
                    }
                });
                usernameInput.dataset.listenerAdded = 'true';
            }
            
            console.log('Chat page initialized');
        };
        
        window.updateTotalTime = function() {
            const days = parseInt(document.getElementById('loadingDays').value) || 0;
            const hours = parseInt(document.getElementById('loadingHours').value) || 0;
            const minutes = parseInt(document.getElementById('loadingMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('loadingSeconds').value) || 0;
            
            const totalSeconds = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;
            
            let displayText = 'Total: ';
            if (days > 0) displayText += days + ' day' + (days > 1 ? 's ' : ' ');
            if (hours > 0) displayText += hours + ' hour' + (hours > 1 ? 's ' : ' ');
            if (minutes > 0) displayText += minutes + ' minute' + (minutes > 1 ? 's ' : ' ');
            if (seconds > 0) displayText += seconds + ' second' + (seconds > 1 ? 's' : '');
            
            if (totalSeconds === 0) displayText = 'Total: 0 seconds';
            
            document.getElementById('totalTimeDisplay').textContent = displayText;
        };
        
        window.startLoadingBar = async function() {
            if (!window.isAdmin) return;
            
            const days = parseInt(document.getElementById('loadingDays').value) || 0;
            const hours = parseInt(document.getElementById('loadingHours').value) || 0;
            const minutes = parseInt(document.getElementById('loadingMinutes').value) || 0;
            const seconds = parseInt(document.getElementById('loadingSeconds').value) || 0;
            
            const totalSeconds = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;
            
            if (totalSeconds < 1) {
                alert('Please enter a valid duration!');
                return;
            }
            
            const loadingRef = ref(database, 'loadingBar');
            await set(loadingRef, {
                active: true,
                duration: totalSeconds,
                startTime: Date.now()
            });
            
            console.log('Loading bar started:', totalSeconds, 'seconds');
        };
        
        window.stopLoadingBar = async function() {
            if (!window.isAdmin) return;
            
            const loadingRef = ref(database, 'loadingBar');
            await set(loadingRef, {
                active: false
            });
            
            console.log('Loading bar stopped');
        };
        
        const loadingBarRef = ref(database, 'loadingBar');
        let loadingInterval = null;
        
        onValue(loadingBarRef, (snapshot) => {
            const loadingState = snapshot.val();
            const overlay = document.getElementById('loadingBarOverlay');
            
            if (loadingState && loadingState.active) {
                overlay.classList.add('active');
                
                const duration = loadingState.duration * 1000;
                const startTime = loadingState.startTime;
                const totalBlocks = 10;
                
                if (loadingInterval) clearInterval(loadingInterval);
                
                loadingInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const percentage = Math.floor(progress * 100);
                    const filledBlocks = Math.floor(progress * totalBlocks);
                    
                    let barText = '[';
                    for (let i = 0; i < totalBlocks; i++) {
                        if (i < filledBlocks) {
                            barText += '<span class="filled">█</span>';
                        } else {
                            barText += '.';
                        }
                    }
                    barText += ']';
                    
                    document.getElementById('loadingBar').innerHTML = barText;
                    document.getElementById('loadingPercentage').textContent = percentage + '%';
                    
                    const remaining = Math.max(0, duration - elapsed);
                    const remainingSeconds = Math.floor(remaining / 1000);
                    const remDays = Math.floor(remainingSeconds / 86400);
                    const remHours = Math.floor((remainingSeconds % 86400) / 3600);
                    const remMinutes = Math.floor((remainingSeconds % 3600) / 60);
                    const remSecs = remainingSeconds % 60;
                    
                    document.getElementById('loadingTimeRemaining').textContent = 
                        `Time remaining: ${remDays}d ${remHours}h ${remMinutes}m ${remSecs}s`;
                    
                    if (progress >= 1) {
                        clearInterval(loadingInterval);
                        setTimeout(async () => {
                            overlay.classList.remove('active');
                            await set(loadingBarRef, { active: false });
                        }, 2000);
                    }
                }, 50);
            } else {
                overlay.classList.remove('active');
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                    loadingInterval = null;
                }
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.isAdmin = true;
                window.adminEmail = user.email;
                window.userId = user.uid;
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('consoleInput').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('adminVoteBtn').style.display = 'block';
                document.getElementById('adminSoundBtn').style.display = 'block';
                document.getElementById('textureControlBtn').style.display = 'block';
                document.getElementById('adminLoadingBtn').style.display = 'block';
                document.getElementById('adminVideoBtn').style.display = 'block';
                if (document.getElementById('adminChatToggleBtn')) document.getElementById('adminChatToggleBtn').style.display = 'block';
                
                document.getElementById('chatDeleteAllBtn').style.display = 'block';
                console.log('Admin logged in:', user.email);
                
                setTimeout(() => {
                    const event = new Event('admin-login');
                    window.dispatchEvent(event);
                }, 100);
            } else {
                window.isAdmin = false;
                window.adminEmail = null;
                window.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                document.getElementById('consoleInput').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminVoteBtn').style.display = 'none';
                document.getElementById('adminSoundBtn').style.display = 'none';
                document.getElementById('videoControlHud').classList.remove('active');
                document.getElementById('textureControlBtn').style.display = 'none';
                document.getElementById('adminLoadingBtn').style.display = 'none';
                document.getElementById('adminVideoBtn').style.display = 'none';
                document.getElementById('adminChatToggleBtn').style.display = 'none';
                
                document.getElementById('chatDeleteAllBtn').style.display = 'none';
            }
        });
        
        const messagesRef = ref(database, 'messages');
        let isFirstLoad = true;
        let messageCount = 0;
        
        function renderMessages() {
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                const messagesDiv = document.getElementById('consoleMessages');
                messagesDiv.innerHTML = '';
                
                if (messages) {
                    const messageArray = Object.entries(messages);
                    messageArray.forEach(([msgId, msg]) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'console-message' + (msg.deleted ? ' deleted' : '');
                        const time = new Date(msg.timestamp).toLocaleTimeString();
                        
                        if (msg.deleted) {
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'message-content';
                            
                            const timestampSpan = document.createElement('span');
                            timestampSpan.className = 'timestamp';
                            timestampSpan.textContent = `[${time}]`;
                            
                            const errorSpan = document.createElement('span');
                            errorSpan.style.color = '#ff4444';
                            errorSpan.textContent = 'ERROR';
                            
                            contentDiv.appendChild(timestampSpan);
                            contentDiv.appendChild(errorSpan);
                            msgDiv.appendChild(contentDiv);
                        } else {
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'message-content';
                            
                            const timestampSpan = document.createElement('span');
                            timestampSpan.className = 'timestamp';
                            timestampSpan.textContent = `[${time}]`;
                            
                            const usernameSpan = document.createElement('span');
                            usernameSpan.className = 'username';
                            usernameSpan.textContent = msg.username + ':';
                            
                            const textNode = document.createTextNode(msg.text);
                            
                            contentDiv.appendChild(timestampSpan);
                            contentDiv.appendChild(usernameSpan);
                            contentDiv.appendChild(textNode);
                            msgDiv.appendChild(contentDiv);
                            
                            if (window.isAdmin) {
                                const deleteBtn = document.createElement('span');
                                deleteBtn.className = 'delete-btn';
                                deleteBtn.textContent = '✕';
                                deleteBtn.onclick = () => deleteMessage(msgId);
                                msgDiv.appendChild(deleteBtn);
                            }
                        }
                        messagesDiv.appendChild(msgDiv);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    const currentCount = messageArray.length;
                    if (!isFirstLoad && currentCount > messageCount) {
                        const alertSound = document.getElementById('alertAudio');
                        if (alertSound) {
                            alertSound.currentTime = 0;
                            alertSound.play().catch(e => console.log('Alert sound failed:', e));
                        }
                    }
                    messageCount = currentCount;
                    isFirstLoad = false;
                }
            });
        }
        
        renderMessages();
        window.addEventListener('admin-login', renderMessages);
        
        const videoStateRef = ref(database, 'videoState');
        onValue(videoStateRef, (snapshot) => {
            const videoState = snapshot.val();
            
            if (videoState && videoState.currentVideo) {
                const newVideo = videoState.currentVideo;
                
                if (newVideo !== window.currentVideo) {
                    const mainVideo = document.getElementById('mainVideo');
                    mainVideo.src = newVideo;
                    mainVideo.load();
                    mainVideo.loop = (newVideo === 'water2.mp4' || newVideo === 'water03.mp4' || newVideo === 'city.mp4' || newVideo === 'sighting.mp4' || newVideo === 'tree.mp4' || newVideo === 'water.mp4');
                    mainVideo.muted = true;
                    mainVideo.play()
                        .then(() => console.log('Video switched successfully'))
                        .catch(e => console.error('Video switch failed:', e));
                    
                    window.currentVideo = newVideo;
                    
                    if (window.isAdmin) {
                        document.querySelectorAll('.video-control-hud button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        const activeBtn = document.querySelector(`[data-video="${newVideo}"]`);
                        if (activeBtn) activeBtn.classList.add('active');
                    }
                }
            }
        });
        
        
        // ========== ENHANCED SOUND CONTROL SYSTEM ==========
        
        window.soundControlState = {
            currentSound: null,
            currentLoop: 0,
            totalLoops: 1,
            isPlaying: false,
            volume: 1.0,
            loopForever: false
        };
        
        window.updateVolumeDisplay = function() {
            const volumeSlider = document.getElementById('soundVolume');
            const volumeValue = document.getElementById('volumeValue');
            if (volumeSlider && volumeValue) {
                volumeValue.textContent = volumeSlider.value + '%';
            }
        };
        
        window.toggleLoopForever = function() {
            const loopForever = document.getElementById('loopForever');
            const loopCount = document.getElementById('loopCount');
            
            if (loopForever && loopCount) {
                if (loopForever.checked) {
                    loopCount.disabled = true;
                    loopCount.style.opacity = '0.5';
                } else {
                    loopCount.disabled = false;
                    loopCount.style.opacity = '1';
                }
            }
        };
        
        window.playSound = async function() {
            if (!window.isAdmin) return;
            
            const soundSelect = document.getElementById('soundSelect');
            const soundFile = soundSelect.value;
            const volumeSlider = document.getElementById('soundVolume');
            const loopCountInput = document.getElementById('loopCount');
            const loopForeverCheckbox = document.getElementById('loopForever');
            
            if (!soundFile) {
                alert('Please select a sound!');
                return;
            }
            
            const volume = parseInt(volumeSlider.value) / 100;
            const loopCount = loopForeverCheckbox.checked ? -1 : parseInt(loopCountInput.value) || 1;
            
            const soundControlRef = ref(database, 'soundControl');
            
            try {
                await set(soundControlRef, {
                    soundFile: soundFile,
                    volume: volume,
                    loopCount: loopCount,
                    timestamp: Date.now(),
                    isPlaying: true
                });
                
                console.log('Sound control updated:', {
                    file: soundFile,
                    volume: volume,
                    loops: loopCount === -1 ? 'infinite' : loopCount
                });
                
                updateCurrentPlayingDisplay(soundFile, volume, loopCount);
                
            } catch (error) {
                console.error('Failed to play sound:', error);
                alert('Error playing sound: ' + error.message);
            }
        };
        
        window.stopSound = async function() {
            if (!window.isAdmin) return;
            
            const soundControlRef = ref(database, 'soundControl');
            
            try {
                await set(soundControlRef, {
                    isPlaying: false,
                    timestamp: Date.now()
                });
                
                const player = document.getElementById('globalSoundPlayer');
                player.pause();
                player.currentTime = 0;
                
                document.getElementById('currentPlaying').classList.remove('active');
                
                window.soundControlState.isPlaying = false;
                window.soundControlState.currentLoop = 0;
                
                console.log('Sound stopped');
                
            } catch (error) {
                console.error('Failed to stop sound:', error);
            }
        };
        
        window.updateCurrentPlayingDisplay = function(soundFile, volume, loopCount) {
            const currentPlaying = document.getElementById('currentPlaying');
            const soundName = document.getElementById('currentSoundName');
            const soundVolume = document.getElementById('currentSoundVolume');
            const soundLoops = document.getElementById('currentSoundLoops');
            
            const fileName = soundFile.split('/').pop().replace(/\.[^/.]+$/, "");
            
            soundName.textContent = fileName;
            soundVolume.textContent = Math.round(volume * 100) + '%';
            
            if (loopCount === -1) {
                soundLoops.textContent = 'Loop: ∞ (Forever)';
            } else {
                soundLoops.textContent = `Loop: 1 / ${loopCount}`;
            }
            
            currentPlaying.classList.add('active');
        };
        
        window.playSoundWithLoop = function() {
            const player = document.getElementById('globalSoundPlayer');
            const state = window.soundControlState;
            
            player.src = state.currentSound;
            player.volume = state.volume;
            
            player.onended = null;
            
            player.onended = function() {
                state.currentLoop++;
                
                if (window.isAdmin && state.totalLoops !== -1) {
                    const soundLoops = document.getElementById('currentSoundLoops');
                    if (soundLoops) {
                        soundLoops.textContent = `Loop: ${state.currentLoop + 1} / ${state.totalLoops}`;
                    }
                }
                
                if (state.loopForever || state.currentLoop < state.totalLoops) {
                    player.currentTime = 0;
                    player.play().catch(e => console.log('Loop play failed:', e));
                } else {
                    state.isPlaying = false;
                    if (window.isAdmin) {
                        document.getElementById('currentPlaying').classList.remove('active');
                    }
                }
            };
            
            player.play().catch(e => console.log('Sound play failed:', e));
            
            console.log('Playing sound:', {
                file: state.currentSound,
                volume: Math.round(state.volume * 100) + '%',
                loops: state.loopForever ? '∞' : state.totalLoops
            });
        };
        
        const soundControlRef = ref(database, 'soundControl');
        
        onValue(soundControlRef, (snapshot) => {
            const control = snapshot.val();
            
            if (!control || !control.isPlaying) {
                const player = document.getElementById('globalSoundPlayer');
                player.pause();
                player.currentTime = 0;
                window.soundControlState.isPlaying = false;
                return;
            }
            
            const { soundFile, volume, loopCount, timestamp } = control;
            
            if (timestamp > (window.soundControlState.lastTimestamp || 0)) {
                window.soundControlState.lastTimestamp = timestamp;
                window.soundControlState.currentSound = soundFile;
                window.soundControlState.volume = volume;
                window.soundControlState.totalLoops = loopCount;
                window.soundControlState.currentLoop = 0;
                window.soundControlState.loopForever = loopCount === -1;
                window.soundControlState.isPlaying = true;
                
                playSoundWithLoop();
            }
        });
        
        setTimeout(() => {
            if (typeof updateVolumeDisplay === 'function') {
                updateVolumeDisplay();
            }
        }, 1000);
        

        
        // ========== CHAT ENABLE/DISABLE SYSTEM ==========
        
        window.toggleChatEnabled = async function() {
            if (!window.isAdmin) return;
            
            const chatEnabledRef = ref(database, 'chatEnabled');
            const snapshot = await new Promise(resolve => {
                onValue(chatEnabledRef, resolve, { onlyOnce: true });
            });
            
            const currentState = snapshot.val();
            const newState = currentState === undefined ? false : !currentState;
            
            await set(chatEnabledRef, newState);
            
            console.log('Chat enabled:', newState);
        };
        
        const chatEnabledRef = ref(database, 'chatEnabled');
        
        onValue(chatEnabledRef, (snapshot) => {
            const enabled = snapshot.val();
            const overlay = document.getElementById('chatDisabledOverlay');
            const toggleBtn = document.getElementById('adminChatToggleBtn');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.querySelector('.chat-send-btn');
            
            // Default to enabled if not set
            const isEnabled = enabled === null || enabled === undefined || enabled === true;
            
            if (window.location.search.includes('chat')) {
                if (!isEnabled) {
                    overlay.classList.add('active');
                    if (chatInput) chatInput.disabled = true;
                    if (sendBtn) sendBtn.disabled = true;
                } else {
                    overlay.classList.remove('active');
                    if (chatInput) chatInput.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                }
            }
            
            if (window.isAdmin && toggleBtn) {
                if (isEnabled) {
                    toggleBtn.textContent = 'DISABLE CHAT';
                    toggleBtn.classList.remove('disabled');
                } else {
                    toggleBtn.textContent = 'ENABLE CHAT';
                    toggleBtn.classList.add('disabled');
                }
            }
        });
        

        const missingTextureRef = ref(database, 'missingTexture');
        onValue(missingTextureRef, (snapshot) => {
            const textureState = snapshot.val();
            const overlay = document.getElementById('missingTextureOverlay');
            
            if (textureState && textureState.active) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        });
    </script>

    <script>
        window.currentVideo = 'water.mp4';
        let audioStarted = false;
        
        if (window.location.search.includes('admin')) {
            document.getElementById('loginPage').classList.add('active');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        if (window.location.search.includes('maps')) {
            document.getElementById('mapsPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            startMapTerminal();
        }
        
        if (window.location.search.includes('data')) {
            document.getElementById('dataPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            startDataTerminal();
        }
        
        if (window.location.search.includes('tgmt')) {
            document.getElementById('tgmtPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
        }
        
        if (window.location.search.includes('chat')) {
            document.getElementById('chatPage').classList.add('active');
            document.getElementById('mainVideo').style.display = 'none';
            document.getElementById('bgAudio').pause();
            
            const savedUsername = localStorage.getItem('chatUsername');
            if (!savedUsername && !window.isAdmin) {
                setTimeout(() => {
                    document.getElementById('usernameModal').classList.add('active');
                }, 500);
            } else if (savedUsername) {
                window.chatUsername = savedUsername;
            }
            
            setTimeout(() => {
                if (typeof setupChatPage === 'function') {
                    setupChatPage();
                }
            }, 100);
        }
        
        const sourceEngineMaps = [
            'maps/cp_dustbowl.bsp', 'maps/ctf_2fort.bsp', 'maps/pl_badwater.bsp',
            'maps/koth_harvest.bsp', 'maps/pl_upward.bsp', 'maps/cp_granary.bsp',
            'maps/ctf_turbine.bsp', 'maps/pl_goldrush.bsp', 'maps/cp_gravelpit.bsp',
            'maps/koth_nucleus.bsp', 'maps/d1_trainstation_01.bsp', 'maps/d1_canals_01.bsp',
            'maps/d1_town_01.bsp', 'maps/d2_coast_01.bsp', 'maps/d3_c17_01.bsp',
            'maps/ep1_citadel_00.bsp', 'maps/ep2_outland_01.bsp', 'maps/de_dust2.bsp',
            'maps/cs_office.bsp', 'maps/de_inferno.bsp', 'maps/de_nuke.bsp',
            'maps/cs_italy.bsp', 'maps/de_aztec.bsp', 'maps/de_train.bsp',
            'maps/cs_assault.bsp', 'maps/gm_construct.bsp', 'maps/gm_flatgrass.bsp',
            'maps/rp_downtown_v4c.bsp', 'maps/gm_bigcity.bsp', 'maps/rp_evocity_v4b1.bsp',
            'maps/ph_restaurant.bsp', 'maps/ttt_minecraft_b5.bsp', 'maps/gm_fork.bsp',
            'maps/de_dust.bsp', 'maps/cs_militia.bsp', 'maps/cp_badlands.bsp',
            'maps/pl_frontier_final.bsp', 'maps/ctf_sawmill.bsp', 'maps/koth_king.bsp',
            'maps/cp_steel.bsp', 'maps/pl_thundermountain.bsp', 'maps/koth_viaduct.bsp',
            'maps/cp_gorge.bsp', 'maps/ctf_doublecross.bsp', 'maps/pl_hoodoo_final.bsp',
            'maps/d1_canals_02.bsp', 'maps/d1_canals_03.bsp', 'maps/d1_eli_01.bsp',
            'maps/d2_prison_01.bsp', 'maps/d2_coast_03.bsp', 'maps/d3_breen_01.bsp',
            'maps/ep1_c17_00.bsp', 'maps/ep2_outland_05.bsp', 'maps/de_cbble.bsp',
            'maps/de_mirage.bsp', 'maps/cs_compound.bsp', 'maps/gm_mobenix_v1_5.bsp',
            'maps/rp_florida.bsp', 'maps/dm_lockdown.bsp', 'maps/de_prodigy.bsp',
            'maps/cs_havana.bsp', 'maps/pl_swiftwater_final1.bsp', 'maps/cp_foundry.bsp',
            'maps/koth_lakeside_final.bsp', 'maps/arena_lumberyard.bsp', 'maps/cp_egypt_final.bsp',
            'maps/pl_barnblitz.bsp', 'maps/ctf_well.bsp', 'maps/cp_yukon_final.bsp',
            'maps/pl_cashworks.bsp', 'maps/koth_badlands.bsp', 'maps/cp_process_final.bsp',
            'maps/d1_trainstation_02.bsp', 'maps/d1_town_02.bsp', 'maps/d2_coast_09.bsp',
            'maps/d3_c17_05.bsp', 'maps/ep1_citadel_03.bsp', 'maps/ep2_outland_12.bsp',
            'maps/gm_wireburg.bsp', 'maps/rp_rockford_v2b.bsp', 'maps/ttt_67thway_v14.bsp',
            'maps/gm_flatgrass_v3.bsp', 'maps/ph_manor.bsp', 'maps/de_cache.bsp',
            'maps/cs_agency.bsp', 'maps/cp_well.bsp', 'maps/arena_watchtower.bsp',
            'maps/koth_sawmill.bsp'
        ];
        
        function startMapTerminal() {
            const terminal = document.getElementById('mapsTerminal');
            let lineCount = 0;
            const maxLines = 100;
            
            function addLine() {
                if (lineCount >= maxLines) {
                    const firstLine = terminal.firstChild;
                    if (firstLine) terminal.removeChild(firstLine);
                }
                
                const line = document.createElement('div');
                line.className = 'maps-line';
                
                if (Math.random() < 0.15) {
                    line.classList.add('highlight');
                }
                
                const map = sourceEngineMaps[Math.floor(Math.random() * sourceEngineMaps.length)];
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                const statuses = ['LOADING', 'PARSING', 'MOUNTING', 'INDEXING', 'VERIFIED', 'CACHED'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                
                line.textContent = `[${timestamp}] ${status}: ${map}`;
                
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
                
                lineCount++;
            }
            
            for (let i = 0; i < 30; i++) {
                setTimeout(addLine, i * 50);
            }
            
            function scheduleNextLine() {
                const delay = Math.random() * 300 + 100;
                setTimeout(() => {
                    addLine();
                    scheduleNextLine();
                }, delay);
            }
            
            scheduleNextLine();
        }
        
        function startDataTerminal() {
            const terminal = document.getElementById('dataTerminal');
            let lineCount = 0;
            const maxLines = 100;
            
            function addLine() {
                if (lineCount >= maxLines) {
                    const firstLine = terminal.firstChild;
                    if (firstLine) terminal.removeChild(firstLine);
                }
                
                const line = document.createElement('div');
                line.className = 'data-line';
                
                const map = sourceEngineMaps[Math.floor(Math.random() * sourceEngineMaps.length)];
                
                const rand = Math.random();
                let status, statusClass;
                if (rand < 0.7) {
                    status = 'PERFECT';
                    statusClass = 'perfect';
                } else if (rand < 0.9) {
                    status = 'DAMAGED';
                    statusClass = 'damaged';
                } else {
                    status = 'CORRUPTED';
                    statusClass = 'corrupted';
                }
                
                line.innerHTML = `
                    <span class="data-file">${map}</span>
                    <span class="data-status ${statusClass}">[${status}]</span>
                `;
                
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
                
                lineCount++;
            }
            
            for (let i = 0; i < 30; i++) {
                setTimeout(addLine, i * 50);
            }
            
            function scheduleNextLine() {
                const delay = Math.random() * 300 + 100;
                setTimeout(() => {
                    addLine();
                    scheduleNextLine();
                }, delay);
            }
            
            scheduleNextLine();
        }
        
        function makeDraggable(element) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY;
            let xOffset = 0, yOffset = 0;

            element.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            element.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', dragEnd);

            function dragStart(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                isDragging = true;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    xOffset = currentX;
                    yOffset = currentY;

                    element.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }

            function dragEnd(e) {
                isDragging = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            makeDraggable(document.getElementById('videoControlHud'));
            makeDraggable(document.getElementById('adminVotePanel'));
            makeDraggable(document.getElementById('adminSoundPanel'));
            makeDraggable(document.getElementById('adminLoadingPanel'));
            
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            const loginPassword = document.getElementById('loginPassword');
            if (loginPassword) {
                loginPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginAdmin();
                    }
                });
            }
        });
        
        function toggleConsole() {
            document.getElementById('console').classList.toggle('active');
        }
        
        window.switchVideo = async function(videoFile) {
            if (!window.isAdmin) return;
            
            const { ref, set } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            const videoStateRef = ref(window.firebaseDB, 'videoState');
            
            try {
                await set(videoStateRef, {
                    currentVideo: videoFile,
                    timestamp: Date.now()
                });
                console.log('Video state updated in Firebase');
            } catch (error) {
                console.error('Failed to update video state:', error);
            }
        };
        
        document.addEventListener('keydown', (e) => {
            if (e.key === '`' || e.key === '~') {
                e.preventDefault();
                toggleConsole();
            }
        });
        
        const mainVideo = document.getElementById('mainVideo');
        const audioElement = document.getElementById('bgAudio');
        const audioBtn = document.getElementById('audioBtn');

        document.body.addEventListener('click', () => {
            if (!audioStarted) {
                audioElement.play();
                audioBtn.textContent = 'MUTE';
                audioStarted = true;
            }
        }, { once: true });

        audioBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (audioElement.paused) {
                audioElement.play();
                audioBtn.textContent = 'MUTE';
            } else {
                audioElement.pause();
                audioBtn.textContent = 'UNMUTE';
            }
            audioStarted = true;
        });

        audioElement.play().then(() => {
            audioBtn.textContent = 'MUTE';
            audioStarted = true;
        }).catch(() => {
            audioBtn.textContent = 'CLICK TO START';
        });
    </script>

    <!-- Chat Disabled Overlay -->
    <div class="chat-disabled-overlay" id="chatDisabledOverlay">
        <div class="chat-disabled-message">CHAT DISABLED</div>
    </div>
    
    <button class="admin-chat-toggle-btn" id="adminChatToggleBtn" onclick="toggleChatEnabled()">DISABLE CHAT</button>


    <!-- Elements Tab Warning -->
    <div class="elements-warning" aria-hidden="true">LEAVE ME ALONE</div>

</body>
</html>
